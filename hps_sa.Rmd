---
title: "hps_sa"
author: "Uriel Lomel√≠"
date: "5/8/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libs, message=FALSE}
library(dplyr)
library(readr)
library(readxl)
library(janitor)
library(ggplot2)
library(ggthemes)
library(ggdark)
library(magrittr)
library(hrbrthemes)
library(showtext)
library(ggridges)
library(tidyr)
library(forcats)
library(Rmisc)
library(questionr)
library(survey)
library(showtext)
library(sysfonts)
library(hrbrthemes)
library(stringr)
```

```{r loading}
week27 <- read_csv("C:/Users/Uriel/Downloads/pulse2021_puf_27.csv")
```

# Checking if I get the same totals as the US Census tables
```{r}
class(week27)

week27 <- as.data.frame(week27)

week27 %>%
  filter(RECVDVACC==1)%>%
  dplyr::count(estate = EST_ST, wt = PWEIGHT)
```

# To change column names 
```{r}
func1 <- function(week) {
  
  week <- week %>%
    janitor::clean_names() # To lower case and underscore instead of spaces
  
  return(week)
}

week27 <- func1(week = week27)
```

# Recode variables
```{r}
hps <- week27 %>%
  mutate(hispanic = ifelse(rhispanic == 2, "Hispanic", "Non-Hispanic"), 
         race = case_when(rrace %in% 1 ~ "White, non-Hispanic",
                          rrace %in% 2 ~ "Black, non-Hispanic",
                          rrace %in% 3 ~ "Asian, non-Hispanic",
                          rrace %in% 4 ~ "Any other race"),
         gender = ifelse(egender == 1, "Male", "Female"),
         education = case_when(eeduc %in% 1:2 ~ "Less or some than HS",
                               eeduc %in% 3 ~ "HS graduate",
                               eeduc %in% 4:5 ~ "Some college", # or Associate's degree
                               eeduc %in% 6 ~ "Bachelor's degree",
                               eeduc %in% 7 ~ "Graduate degree"),
         marital = case_when(ms %in% 1 ~ "Married",
                             ms %in% 2:4 ~"Separate", # Widow, divorced or separated
                             ms %in% 5 ~ "Single"))

hps$race <- ordered(hps$race, levels = c("White, non-Hispanic", "Black, non-Hispanic", "Asian, non-Hispanic", "Any other race"))

hps$gender <- ordered(hps$gender, levels = c("Male", "Female"))

hps$education <- ordered(hps$education, 
                          levels = c("Less or some than HS", "HS graduate", "Some college", "Bachelor's degree", "Graduate degree"))

hps$marital <- ordered(hps$marital, levels = c("Married", "Separate", "Single"))

hps <- hps%>%
  mutate(work.loss = if_else(wrkloss == 1, "Yes", "No"),
         metro = case_when(est_msa %in% '35620' ~ "New York-Newark-Jersey City",
                           est_msa %in% '31080' ~ "Los Angeles-Long Beach-Anaheim",
                           est_msa %in% '16980' ~ "Chicago-Naperville-Elgin",
                           est_msa %in% '19100' ~ "Dallas-Fort Worth-Arlington",
                           est_msa %in% '26420' ~ "Houston-The Woodlands-Sugar Land",
                           est_msa %in% '47900' ~ "Washington-Arlington-Alexandria",
                           est_msa %in% '33100' ~ "Miami-Fort Lauderdale-Pompano Beach",
                           est_msa %in% '37980' ~ "Philadelphia-Camden-Wilmington", 
                           est_msa %in% '12060' ~ "Atlanta-Sandy Springs-Alpharetta", 
                           est_msa %in% '38060' ~ "Phoenix-Mesa-Chandler", 
                           est_msa %in% '14460' ~ "Boston-Cambridge-Newton", 
                           est_msa %in% '41860' ~ "San Francisco-Oakland-Berkeley",
                           est_msa %in% '40140' ~ "Riverside-San Bernardino-Ontario",
                           est_msa %in% '19820' ~ "Detroit-Warren-Dearborn",
                           est_msa %in% '42660' ~ "Seattle-Tacoma-Bellevue"),
         employment = if_else(anywork == 1, "Employed last week", "Not employed last week"),
         rsn.nowork = case_when(rsnnowrk %in% 1 ~ "I did not want to be employed at this time", 
                                rsnnowrk %in% 2 ~ "I am/was sick with coronavirus symptoms", 
                                rsnnowrk %in% 3 ~ "I am/was caring for someone with coronavirus symptoms", 
                                rsnnowrk %in% 4 ~ "I am/was caring for children not in school or daycare", 
                                rsnnowrk %in% 5 ~ "I am/was caring for an elderly person", 
                                rsnnowrk %in% 6 ~ "I am/was sick (not coronavirus related) or disabled", 
                                rsnnowrk %in% 7 ~ "I am retired", 
                                rsnnowrk %in% 8 ~ "My employer experienced a reduction in business (including furlough) due to coronavirus pandemic", 
                                rsnnowrk %in% 9 ~ "I am/was laid off due to coronavirus pandemic", 
                                rsnnowrk %in% 10 ~ "My employment closed temporarily due to the coronavirus pandemic", 
                                rsnnowrk %in% 11 ~ "My employment went out of business due to the coronavirus pandemic", 
                                rsnnowrk %in% 12 ~ "Other reason",
                                rsnnowrk %in% 13 ~ "I was concerned about getting or spreading the coronavirus"))
```

```{r}
# hps <- hps %>%
#   mutate(eip2 = case_when(eip %in% 1 ~ "Mostly to pay for expenses",
#                          eip %in% 2 ~ "Mostly to pay off debt",
#                          eip %in% 3 ~ "Mostly to add to savings",
#                          eip %in% 4 ~ "I didn't and don't expect to receive it"),
#          health = case_when(hlthstatus %in% 1 ~ "Excellent",
#                             hlthstatus %in% 2 ~ "Very good",
#                             hlthstatus %in% 3 ~ "Good",
#                             hlthstatus %in% 4 ~ "Fair",
#                             hlthstatus %in% 5 ~ "Poor"))
# 
# hps$health.num <- recode(hps$health, "Excellent" = 1, "Very good" = 2, "Good" = 3, "Fair" = 4, "Poor" = 5)

 
#-99) Question seen but category not selected
#-88) Missing / Did not report

hps <- hps %>% 
  mutate(mh_anxious = case_when(anxious %in% 1 ~ "Not at all",
                                anxious %in% 2 ~ "Several days",
                                anxious %in% 3 ~ "More than half the days",
                                anxious %in% 4 ~ "Nearly every day"),
         mh_worry = case_when(worry %in% 1 ~ "Not at all",
                              worry %in% 2 ~ "Several days",
                              worry %in% 3 ~ "More than half the days",
                              worry %in% 4 ~ "Nearly every day"),
         mh_interest = case_when(interest %in% 1 ~ "Not at all",
                                 interest %in% 2 ~ "Several days",
                                 interest %in% 3 ~ "More than half the days",
                                 interest %in% 4 ~ "Nearly every day"),
         mh_down = case_when(down %in% 1 ~ "Not at all",
                             down %in% 2 ~ "Several days",
                             down %in% 3 ~ "More than half the days",
                             down %in% 4 ~ "Nearly every day"))

hps <- hps%>%
  mutate(mh_anxious = ifelse(anxious > 0, anxious, NA),
         mh_worrry = ifelse(worry > 0, worry, NA),
         mh_interest = ifelse(interest > 0, interest, NA),
         mh_down = ifelse(down > 0, down, NA))

hps <- hps%>%
  mutate(age = 2020 - tbirth_year)%>%
  mutate(ageg = case_when(age %in% 18:24 ~ "18 to 24",
                          age %in% 25:34 ~ "25 to 34",
                          age %in% 35:44 ~ "35 to 44",
                          age %in% 45:54 ~ "45 to 54",
                          age %in% 55:64 ~ "55 to 64",
                          age %in% 65:74 ~ "65 to 74",
                          age %in% 75:100 ~ "75 or more"))

hps$ageg <- ordered(hps$ageg, levels = c("18 to 24", "25 to 34", "35 to 44", "45 to 54", "55 to 64", "65 to 74", "75 or more"))

hps$state <- recode(hps$est_st, '01'='Alabama', '02'='Alaska', '04'='Arizona', '05'='Arkansas', '06'='California',
                     '08'='Colorado', '09'='Connecticut', '10'='Delaware', '11'='District of Columbia', '12'='Florida',
                     '13'='Georgia', '15'='Hawaii', '16'='Idaho', '17'='Illinois', '18'='Indiana', '19'='Iowa', '20'='Kansas',
                     '21'='Kentucky', '22'='Louisiana', '23'='Maine', '24'='Maryland', '25'='Massachusetts', '26'='Michigan',
                     '27'='Minnesota', '28'='Mississippi', '29'='Missouri', '30'='Montana', '31'='Nebraska', '32'='Nevada',
                     '33'='New Hampshire', '34'='New Jersey', '35'='New Mexico', '36'='New York', '37'='North Carolina',
                     '38'='North Dakota', '39'='Ohio', '40'='Oklahoma', '41'='Oregon', '42'='Pennsylvania', '44'='Rhode Island',
                     '45'='South Carolina', '46'='South Dakota', '47'='Tennessee', '48'='Texas', '49'='Utah', '50'='Vermont',
                     '51'='Virginia', '53'='Washington', '54'='West Virginia', '55'='Wisconsin', '56'='Wyoming')
```

# subset
```{r}
# hps <- hps %>%
#   select(scram:pweight, prifoodsuf:freefood, anxious:down, enroll1:teach5, income, eip:eipspnd13, hispanic:state)

hps %>%
  filter(!is.na(mh_anxious)) %>% 
  dplyr::count(gender, mh_anxious, wt = pweight)

hps %>%
  filter(!is.na(mh_anxious)) %>% 
  group_by(gender) %>% 
  dplyr::count(gender, mh_anxious, wt = pweight) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1)) 

hps$race_eth <- interaction(hps$race, hps$hispanic)

hps$race_eth2<-ifelse(str_sub(as.character(hps$race_eth), start = -12)==
                        "Non-Hispanic", as.character(hps$race_eth),"Hispanic")


```

```{r}
data %>%
  filter(!is.na(mental_health_anxious)) %>% 
  group_by(gender2, mental_health_anxious) %>%
  dplyr::summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1))  
```

```{r }
library(gtsummary)
install.packages("flextable")
library(flextable)
options(survey.lonely.psu = "adjust")
# To have a compact table (not necessary if you need a compact table or can be postprocessed)
set_gtsummary_theme(theme_gtsummary_compact(set_theme = TRUE))

hps$mh_anxious <- factor(hps$mh_anxious)
hps$gender <- factor(hps$gender)

table <- survey::svydesign(ids=~1, weights = ~pweight, data = hps, strata = NULL, nest = F) %>%
  tbl_svysummary(by= "mh_anxious", # stratification variable.
                 include = c(mh_anxious, gender), 
                 percent = "column",  #Column or Row percentage, depending on your needs
                 
                 digits = list(all_continuous() ~ c(1,1), 
                               all_categorical() ~ 1))

class(hps$gender)
```

```{r}
# install.packages("expss")
# library(expss)

fre(hps$mh_anxious, weight = hps$pweight)

fre(data$mental_health_anxious)
```

```{r}
cro_cpct(cell_vars = hps$mh_anxious, col_vars = hps$gender, weight = hps$pweight)
cro_cpct(cell_vars = data$mental_health_anxious, col_vars = data$gender2)

cro_cpct(cell_vars = hps$mh_anxious, col_vars = hps$race_eth2, weight = hps$pweight)
cro_cpct(cell_vars = data$mental_health_anxious, col_vars = data$race_eth)
```

```{r}
cro_cpct(cell_vars = hps$mh_worry, col_vars = hps$gender, weight = hps$pweight)

cro_cpct(cell_vars = data$mental_health_worry, col_vars = data$gender2)
```

```{r}
cro_cpct(cell_vars = hps$mh_interest, col_vars = hps$gender, weight = hps$pweight)

cro_cpct(cell_vars = data$mental_health_interest, col_vars = data$gender2)
```

```{r}
cro_cpct(cell_vars = hps$mh_down, col_vars = hps$gender, weight = hps$pweight)

cro_cpct(cell_vars = data$mental_health_down, col_vars = data$gender2)
```


```{r}

```























