---
title: "Socioeconomic Outcomes of Residents in San Antonio During the COVID-19 Pandemic: Evidence from a Local Community Survey"
author: "..."
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    highlight: tango
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libs, message=FALSE, include=FALSE}
library(ggplot2)
library(ggrepel)
library(dplyr)
library(ggsci)
library(wesanderson)
library(stringr)
library(moe)
library(patchwork)
```

```{r load, include=FALSE}
load(file = "~/GitHub/saetus/data_recode.RData")

data <- data %>% 
  mutate_at(vars(hardships_1:hardships_6), funs(recode(., "Yes" = as.numeric(1), "No" = as.numeric(0)))) %>% 
  mutate(hards = hardships_1 + hardships_2 + hardships_3 + hardships_4 + hardships_5 + hardships_6, 
         race_eth2 = case_when(race_eth %in% "NH-White" ~ "Non-Hispanic White",
                               race_eth %in% "Hispanic" ~ "Hispanic",
                               race_eth %in% "NH-Black" ~ "Non-Hispanic Black",
                               race_eth %in% "NH-Asian" ~ "Non-Hispanic Asian",
                               race_eth %in% c("NH-AIAN", "NH-NHPI", "NH-Other") ~ "Non-Hispanic Other"),
         race_eth3 = case_when(race_eth %in% "NH-White" ~ "Non-Hispanic White",
                               race_eth %in% "Hispanic" ~ "Hispanic",
                               race_eth %in% c("NH-Black", "NH-Asian", "NH-AIAN", "NH-NHPI", "NH-Other") ~ "Non-Hispanic Other"),
         bad = if_else(hards == 1, "One hardship", 
                       if_else(hards == 2, "Two hardships",
                               if_else(hards > 2, "More than two", NA_character_))))

data$bad <- ordered(data$bad, levels = c("One hardship", "Two hardships", "More than two"))
data$race_eth <- ordered(data$race_eth, levels = c("Hispanic", "NH-White", "NH-Black", "NH-Asian", "NH-AIAN", "NH-NHPI", "NH-Other"))
data$race_eth2 <- ordered(data$race_eth2, 
                          levels = c("Hispanic", "Non-Hispanic White", "Non-Hispanic Black", "Non-Hispanic Asian","Non-Hispanic Other"))
data$race_eth3 <- ordered(data$race_eth3, levels = c("Hispanic", "Non-Hispanic White", "Non-Hispanic Other"))
data$health <- ordered(data$health, levels = c("Excellent", "Very good", "Good", "Fair", "Poor"))
```

```{r themeu, include=FALSE, message=FALSE, warning=FALSE}
sysfonts::font_add_google(name = 'Lato', family = "foo")
showtext::showtext_auto()

themeu <- theme(legend.position = "bottom", 
                legend.text = element_text(size = 15, color = "gray40"), 
                legend.key.size = unit(.5, "cm"),
                panel.background = element_rect(colour = "black"),
                plot.title = element_text(face = "bold", size = 30, hjust = .5, vjust = .5, lineheight = .5), 
                plot.caption = element_text(size = 15),
                plot.subtitle = element_text(colour = "gray50", face = "bold", size = 22, lineheight = .5, hjust = .5, vjust = .5),
                axis.text = element_text(size = 20), 
                text = element_text(family = "foo"))

themeuf <- theme(legend.position = "top", 
                 legend.text = element_text(size = 25, color = "gray30"), 
                 legend.key.size = grid::unit(.5, "cm"), 
                 legend.title = element_text(color = "gray25", face = "bold", size = 20), 
                 panel.background = element_rect(colour = "black"),
                 plot.title = element_text(face = "bold", size = 32, hjust = .5, vjust = .5, lineheight = .5), 
                 plot.caption = element_text(size = 19),
                 plot.subtitle = element_text(colour = "gray30", face = "bold", size = 26, lineheight = .5, hjust = .5, vjust = .5),
                 axis.text = element_text(size = 27, color = "gray10", face = "bold"),
                 strip.text = element_text(size = 25), 
                 axis.title.x = element_text(color = "gray10", size = 25), 
                 axis.ticks.y = element_blank(),
                 panel.grid.major.x = element_blank(),
                 panel.grid.minor.x = element_blank(),
                 panel.grid.major.y = element_line(colour = "grey70", linetype = "dotted"),
                 plot.tag = element_text(size = 30),
                 text = element_text(family = "foo"))
```

<center> <h1>Background</h1> </center> 
<br>
Ever since San Antonio confirmed its first COVID-19 case more than one year ago, the COVID-19 pandemic and the associated social and economic fallout have upended the lives of many locally. The significant social and economic disruptions have caused tremendous stress for virtually everyone in our communities. The pandemic has challenged people's everyday routines on an unprecedented scale. Joblessness remains high and many report that their households lack sufficient food to eat or are not able to make rental, medical, utility bill payments. These significant stressors following COVID-19 could exert negative impacts on people's physical and mental health. The potential economic hardship and health consequences following the pandemic are likely to be unequally distributed and shaped by different ecological structure of local neighborhood conditions. In this policy brief, we compare and contrast two neighborhoods with drastic differences in racial and ethnic composition and socioeconomic status. [maybe add a sentence or two about families with dependent, childcare, etc]

<center> <h1>Data collection and Methods</h1> </center>  
<br>
-questionnaire design

The **San Antonio Energy and Time Use Survey** is an online survey that was answered between March 22-24 by residents of zip codes 78230 (referred to as Elm Creek) and 78202 (referred to as Jefferson Heights). The household level questionnaire collects information on time use, energy consumption, health status and medical devices, employment situation and demographic characteristics.  Upon completion of the survey, respondents received a \$10 Target e-gift card as a compensation for their time. We specifically chose two study sites that are different from each other in terms of racial and ethnic composition and socioeconomic conditions. The study was approved by UTSA IRB. 

**Elm Creek** neighborhood, contained within the city limits of San Antonio, TX, Shavano Park, TX, and Castle Hills, TX. The income per capita of \$38,640 is 1.3 times the income per capita for the San Antonio-New Braunfels Metro Area ($29,071). 93.6% of the population within the zip code has at least gained their high school diploma while only 6% of the population has not gained any sort of degree. 48% of the population is of Hispanic heritage, followed by 39% of the population identifying as White. The minority population in Elm Creek is Asian, with only 5% identifying as Asian. Regarding poverty, **12.5% of people are below the poverty line** with children (under 18) at a 17% below the poverty line and seniors (65 and over) are at a 7%.

Whereas **Jefferson Heights** â€” a disadvantaged neighborhood located in the east side of San Antonio, TX, income per capita of \$18,710 is almost two-thirds of the per capita income of San Antonio-New Braunfels Metro Area. 68.1% of the population in Jefferson Heights has at least gained their high school diploma while 32% of the population has not gained any sort of degree. 60% of the population is of Hispanic heritage, followed by 27% of the population identifying as Black. Aside from a 2% identifying as two or more races, the minority population in this zip code is White, with only 11% identifying as White. Regarding poverty, **37.8% of people are below the poverty line**, making it more than double of the average 14.4% rate in the San Antonio-New Braunfels Metro Area with children (under 18) at a 58% poverty and seniors (65 and over) are at 21% poverty.

We launched our online survey on March 22, 2021 on *Qualtrics*. From March 22 to March 24, we collected 1022 survey respondents, of which 805 were valid responses with complete information on key demographic and socioeconomic information. We excluded 63 respondents from other zip codes and 154 respondents for  due to lack of information, and inconsistencies with their response time and the number of valid responses. The final analytical sample consists of 805 respondents in total, of which 479 are from Elm Creek and 326 are from Jefferson Heights. 

*Include 1 table & 1 figure to demonstrate the differences between two neighborhoods*

<center> <h1>Results</h1> </center>  
<br>

<center> <h2>Proportion of frontline workers by race and ethnicity and by neighborhood</h2> </center>  
<br>

```{r moe_frontline, include=FALSE, message=FALSE, warning=FALSE}
#devtools::install_github("peterdalle/moe")
data.ec <- data %>% 
  filter(zipcode == "Elm Creek" & !is.na(frontline))

data.jh <- data %>% 
  filter(zipcode == "Jefferson Heights" & !is.na(frontline))

nec <- 230 + 171 + 64
njh <- 145 + 142 + 32

frontline.prop.ec <- prop.table(table(data.ec$frontline, data.ec$race_eth3), 2)
frontline.prop.jh <- prop.table(table(data.jh$frontline, data.jh$race_eth3), 2)

frontline_pct_ec <- c(0.4782609, 0.3236994, 0.1538462)
frontline_pct_jh <- c(0.5342466, 0.4100719, 0.3636364)

frontline_ec_moe <- sapply(frontline_pct_ec, FUN = moe, n = nec, population.correction = T, population.size = 18223)
frontline_jh_moe <- sapply(frontline_pct_jh, FUN = moe, n = njh, population.correction = T, population.size = 3812)

lower1 <- round(frontline_ec_moe[, 1]$conf.lower/100, 2)
upper1 <- round(frontline_ec_moe[, 1]$conf.upper/100, 2)

lower2 <- round(frontline_ec_moe[, 2]$conf.lower/100, 2)
upper2 <- round(frontline_ec_moe[, 2]$conf.upper/100, 2)

lower3 <- round(frontline_ec_moe[, 3]$conf.lower/100, 2)
upper3 <- round(frontline_ec_moe[, 3]$conf.upper/100, 2)

lower1b <- round(frontline_jh_moe[, 1]$conf.lower/100, 2)
upper1b <- round(frontline_jh_moe[, 1]$conf.upper/100, 2)

lower2b <- round(frontline_jh_moe[, 2]$conf.lower/100, 2)
upper2b <- round(frontline_jh_moe[, 2]$conf.upper/100, 2)

lower3b <- round(frontline_jh_moe[, 3]$conf.lower/100, 2)
upper3b <- round(frontline_jh_moe[, 3]$conf.upper/100, 2)
```

```{r moe_unemployed, include=FALSE, message=FALSE, warning=FALSE}
data <- data %>%
  mutate_at(vars(emp_status), ~if_else(. %in% c("Work for pay at a job","Temporarily absent from job"), "employed",
                                    if_else(. %in% c("Layoff from a job","Actively looking for a job"), "unemployed",
                                            if_else(. %in% c("Retired", "Unable to work"), "retired", "NA"))))
data.ec.unemp <- data %>% 
  filter(emp_status != "NA", zipcode == "Elm Creek")

data.jh.unemp <- data %>% 
  filter(emp_status != "NA", zipcode == "Jefferson Heights")

nec.unemp <- 230 + 171 + 64
njh.unemp <- 145 + 142 + 32

unemp.prop.ec <- prop.table(table(data.ec.unemp$emp_status, data.ec.unemp$race_eth3), 2)
unemp.prop.jh <- prop.table(table(data.jh.unemp$emp_status, data.jh.unemp$race_eth3), 2)

unemp_pct_ec <- c(0.14347826, 0.14619883, 0.20312500)
unemp_pct_jh <- c(0.10344828, 0.18309859, 0.37500000)

unemp_ec_moe <- sapply(unemp_pct_ec, FUN = moe, n = nec.unemp, population.correction = T, population.size = 18223)
unemp_jh_moe <- sapply(unemp_pct_jh, FUN = moe, n = njh.unemp, population.correction = T, population.size = 3812)

lower1u <- round(unemp_ec_moe[, 1]$conf.lower/100, 2)
upper1u <- round(unemp_ec_moe[, 1]$conf.upper/100, 2)

lower2u <- round(unemp_ec_moe[, 2]$conf.lower/100, 2)
upper2u <- round(unemp_ec_moe[, 2]$conf.upper/100, 2)

lower3u <- round(unemp_ec_moe[, 3]$conf.lower/100, 2)
upper3u <- round(unemp_ec_moe[, 3]$conf.upper/100, 2)

lower1bu <- round(unemp_jh_moe[, 1]$conf.lower/100, 2)
upper1bu <- round(unemp_jh_moe[, 1]$conf.upper/100, 2)

lower2bu <- round(unemp_jh_moe[, 2]$conf.lower/100, 2)
upper2bu <- round(unemp_jh_moe[, 2]$conf.upper/100, 2)

lower3bu <- round(unemp_jh_moe[, 3]$conf.lower/100, 2)
upper3bu <- round(unemp_jh_moe[, 3]$conf.upper/100, 2)
```

```{r moe_loss, include=FALSE, message=FALSE, warning=FALSE}
loss <- data %>%
  filter(hardships_1 == 1) %>% 
  group_by(zipcode, race_eth3) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1)) 

loss.ec <- loss %>% filter(zipcode == "Elm Creek")
loss.jh <- loss %>% filter(zipcode == "Jefferson Heights")

nec.loss <- sum(loss.ec$n)
njh.loss <- sum(loss.jh$n)

loss_ec_moe <- sapply(loss.ec$pct, FUN = moe, n = nec.loss, population.correction = T, population.size = 18223)
loss_jh_moe <- sapply(loss.jh$pct, FUN = moe, n = njh.loss, population.correction = T, population.size = 3812)

lower1u <- round(loss_ec_moe[, 1]$conf.lower/100, 2)
upper1u <- round(loss_ec_moe[, 1]$conf.upper/100, 2)

lower2u <- round(loss_ec_moe[, 2]$conf.lower/100, 2)
upper2u <- round(loss_ec_moe[, 2]$conf.upper/100, 2)

lower3u <- round(loss_ec_moe[, 3]$conf.lower/100, 2)
upper3u <- round(loss_ec_moe[, 3]$conf.upper/100, 2)

lower1bu <- round(loss_jh_moe[, 1]$conf.lower/100, 2)
upper1bu <- round(loss_jh_moe[, 1]$conf.upper/100, 2)

lower2bu <- round(loss_jh_moe[, 2]$conf.lower/100, 2)
upper2bu <- round(loss_jh_moe[, 2]$conf.upper/100, 2)

lower3bu <- round(loss_jh_moe[, 3]$conf.lower/100, 2)
upper3bu <- round(loss_jh_moe[, 3]$conf.upper/100, 2)

loss$lower <- c(lower1u, lower2u, lower3u, lower1bu, lower2bu, lower3bu)
loss$upper <- c(upper1u, upper2u, upper3u, upper1bu, upper2bu, upper3bu)
```

```{r moe_welfare, include=FALSE, message=FALSE, warning=FALSE}
welfare <- data %>%
  mutate_at(vars(welfare_1:welfare_7), ~if_else(. == "Yes", 1, 0))

welfare$total_welfare <- rowSums(welfare[, c("welfare_1","welfare_2","welfare_3","welfare_4","welfare_5","welfare_6","welfare_7")],
                                 na.rm = TRUE)
welfare <- welfare %>%
  filter(!is.na(welfare_1)&!is.na(welfare_2)&!is.na(welfare_3)&
           !is.na(welfare_4)&!is.na(welfare_5)&!is.na(welfare_6)&!is.na(welfare_7)) %>% 
  group_by(zipcode, race_eth3) %>%
  summarize(average_welfare = round(mean(total_welfare), 2),
            n = n())

welfare.ec <- c(1.77, 1.79, 1.63)
welfare.jh <- c(1.84, 1.86, 1.81)

t.test(welfare$average_welfare ~ welfare$zipcode)
summary(aov(formula = average_welfare ~ zipcode+race_eth3, data = welfare))
```

```{r moe_hardships, include=FALSE, message=FALSE, warning=FALSE}
loss.1 <- data %>% 
  filter(!is.na(hardships_1)) %>% 
  rename(hardships = hardships_1) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Job loss", 
                               if_else(hardships == 0, "No difficulty", "NA"))) 

loss.2 <- data %>% 
  filter(!is.na(hardships_2)) %>% 
  rename(hardships = hardships_2) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Paying utility bills", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.3 <- data %>% 
  filter(!is.na(hardships_3)) %>% 
  rename(hardships = hardships_3) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Affording foods", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.4 <- data %>% 
  filter(!is.na(hardships_4)) %>% 
  rename(hardships = hardships_4) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Paying rent/mortgage", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.5 <- data %>% 
  filter(!is.na(hardships_5)) %>% 
  rename(hardships = hardships_5) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Paying medical bills", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.6 <- data %>% 
  filter(!is.na(hardships_6)) %>% 
  rename(hardships = hardships_6) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Delay getting medical care", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

hardships <- rbind(loss.1, loss.2, loss.3, loss.4, loss.5, loss.6)

hardships.ec <- hardships %>% 
  filter(zipcode == "Elm Creek", hardships != "No difficulty") %>% arrange(zipcode)

hardships.jh <- hardships %>% 
  filter(zipcode == "Jefferson Heights", hardships != "No difficulty") %>% arrange(zipcode)

hardships_pct_ec <- c(0.65484634, 0.20803783, 0.25059102, 0.26950355, 0.17494090, 0.08510638)
hardships_pct_jh <- c(0.6583630, 0.2206406, 0.2953737, 0.3202847, 0.1886121, 0.1281139)

hardships_ec_moe <- sapply(hardships_pct_ec, FUN = moe, n = 423, population.correction = T, population.size = 18223)
hardships_jh_moe <- sapply(hardships_pct_jh, FUN = moe, n = 281, population.correction = T, population.size = 3812)

lower1 <- round(hardships_ec_moe[, 1]$conf.lower/100, 2)
upper1 <- round(hardships_ec_moe[, 1]$conf.upper/100, 2)

lower2 <- round(hardships_ec_moe[, 2]$conf.lower/100, 2)
upper2 <- round(hardships_ec_moe[, 2]$conf.upper/100, 2)

lower3 <- round(hardships_ec_moe[, 3]$conf.lower/100, 2)
upper3 <- round(hardships_ec_moe[, 3]$conf.upper/100, 2)

lower4 <- round(hardships_ec_moe[, 4]$conf.lower/100, 2)
upper4 <- round(hardships_ec_moe[, 4]$conf.upper/100, 2)

lower5 <- round(hardships_ec_moe[, 5]$conf.lower/100, 2)
upper5 <- round(hardships_ec_moe[, 5]$conf.upper/100, 2)

lower6 <- round(hardships_ec_moe[, 6]$conf.lower/100, 2)
upper6 <- round(hardships_ec_moe[, 6]$conf.upper/100, 2)

lower1b <- round(hardships_jh_moe[, 1]$conf.lower/100, 2)
upper1b <- round(hardships_jh_moe[, 1]$conf.upper/100, 2)

lower2b <- round(hardships_jh_moe[, 2]$conf.lower/100, 2)
upper2b <- round(hardships_jh_moe[, 2]$conf.upper/100, 2)

lower3b <- round(hardships_jh_moe[, 3]$conf.lower/100, 2)
upper3b <- round(hardships_jh_moe[, 3]$conf.upper/100, 2)

lower4b <- round(hardships_jh_moe[, 4]$conf.lower/100, 2)
upper4b <- round(hardships_jh_moe[, 4]$conf.upper/100, 2)

lower5b <- round(hardships_jh_moe[, 5]$conf.lower/100, 2)
upper5b <- round(hardships_jh_moe[, 5]$conf.upper/100, 2)

lower6b <- round(hardships_jh_moe[, 6]$conf.lower/100, 2)
upper6b <- round(hardships_jh_moe[, 6]$conf.upper/100, 2)
```

```{r moe_bad, include=FALSE, message=FALSE, warning=FALSE}
bad <- data %>%
  filter(!is.na(bad)) %>% 
  group_by(zipcode, bad) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1))

bad.ec <- bad %>% filter(zipcode == "Elm Creek")
bad.jh <- bad %>% filter(zipcode == "Jefferson Heights")

nec.bad <- sum(bad.ec$n)
njh.bad <- sum(bad.jh$n)

bad_ec_moe <- sapply(bad.ec$pct, FUN = moe, n = nec.bad, population.correction = T, population.size = 18223)
bad_jh_moe <- sapply(bad.jh$pct, FUN = moe, n = njh.bad, population.correction = T, population.size = 3812)

lower1bad <- round(bad_ec_moe[, 1]$conf.lower/100, 2)
upper1bad <- round(bad_ec_moe[, 1]$conf.upper/100, 2)

lower2bad <- round(bad_ec_moe[, 2]$conf.lower/100, 2)
upper2bad <- round(bad_ec_moe[, 2]$conf.upper/100, 2)

lower3bad <- round(bad_ec_moe[, 3]$conf.lower/100, 2)
upper3bad <- round(bad_ec_moe[, 3]$conf.upper/100, 2)

lower1bbad <- round(bad_jh_moe[, 1]$conf.lower/100, 2)
upper1bbad <- round(bad_jh_moe[, 1]$conf.upper/100, 2)

lower2bbad <- round(bad_jh_moe[, 2]$conf.lower/100, 2)
upper2bbad <- round(bad_jh_moe[, 2]$conf.upper/100, 2)

lower3bbad <- round(bad_jh_moe[, 3]$conf.lower/100, 2)
upper3bbad <- round(bad_jh_moe[, 3]$conf.upper/100, 2)

bad$lower <- c(lower1bad, lower2bad, lower3bad, lower1bbad, lower2bbad, lower3bbad)
bad$upper <- c(upper1bad, upper2bad, upper3bad, upper1bbad, upper2bbad, upper3bbad)
```

```{r frontline_plot, message=FALSE, warning=FALSE}
frontline <- NULL
total <- NULL
frontline_pct <- NULL

total <- data %>%
  filter(!is.na(frontline)) %>% 
  group_by(zipcode, race_eth3) %>%
  summarize(n = n())

frontline <- data %>%
  filter(frontline == "Yes") %>%
  group_by(zipcode, race_eth3) %>%
  summarize(frontline_n = n())

frontline_pct <- data.frame(total[,"zipcode"], total[,"race_eth3"], total[,"n"], frontline[,"frontline_n"])

frontline_pct <- frontline_pct %>%
  mutate(pct = frontline_n/n,
               lbl = scales::percent(pct, accuracy = 0.1))

frontline_pct$lower <- c(lower1, lower2, lower3, lower1b, lower2b, lower3b)
frontline_pct$upper <- c(upper1, upper2, upper3, upper1b, upper2b, upper3b)

frontline_pct %>%
  ggplot(aes(x = pct, y = reorder(race_eth3, pct), color = zipcode)) + 
  geom_errorbar(aes(xmin = lower, xmax = upper), show.legend = F, width = 0.15) +
  geom_point(aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 7, color = "gray10", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(limits = c(0, .6), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)),
         size = F) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Figure 1. Frontline workers by race and ethnicity", 
       subtitle = str_wrap("Are you a frontline worker?"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

ggsave(filename = "figure_1.png", plot = last_plot(), path = "~/GitHub/saetus/", width = 6, height = 4.5, units = "in", dpi = "print")
```

<center> <h2>Unemployment status by race and ethnicity and by neighborhood</h2> </center>  

```{r unemp_plot, warning=FALSE, message=FALSE}
total <- data %>%
  filter(emp_status != "NA") %>%
  group_by(zipcode, race_eth3) %>%
  summarize(n = n())

unemployed <- data %>%
  filter(emp_status == "unemployed") %>%
  group_by(zipcode, race_eth3) %>%
  summarize(unemployed_n = n())

unemployed <- data.frame(unemployed)

colnames(unemployed) <- c("zipcode","race_eth3","unemployed_n")

unemployed <- unemployed[with(unemployed, order(zipcode, race_eth3)),] 

unemployed_pct <- data.frame(total[,"zipcode"], total[,"race_eth3"], total[,"n"], unemployed[,"unemployed_n"])

colnames(unemployed_pct) <- c("zipcode","race_eth3","n","unemployed_n")

unemployed_pct$unemployed_n <- as.numeric(unemployed_pct$unemployed_n)

unemployed_pct <- unemployed_pct %>%
        mutate(pct = unemployed_n/n,
               lbl = scales::percent(pct, accuracy = 0.1))

unemployed_pct$lower <- c(lower1u, lower2u, lower3u, lower1bu, lower2bu, lower3bu)
unemployed_pct$upper <- c(upper1u, upper2u, upper3u, upper1bu, upper2bu, upper3bu)

fig2 <- unemployed_pct %>%
  ggplot(aes(x = pct, y = reorder(race_eth3, -pct), color = zipcode)) + 
  geom_errorbar(aes(xmin = lower, xmax = upper), show.legend = F, width = 0.1) +
  geom_point(aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 7, color = "gray10", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(limits = c(0, .45), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), 
         size = F) +
  labs(y = NULL, x = NULL, color = NULL, 
       subtitle = "A) Unemployment by race and ethnicity") +
  theme_classic() +
  themeuf + theme(legend.position = "bottom") 

ggsave(filename = "figure_2.png", plot = last_plot(), path = "~/GitHub/saetus/", width = 6, height = 4.5, units = "in", dpi = "print")
```

<center> <h2>Income loss by race and ethnicity and by neighborhood</h2> </center>
<br>
```{r loss_income_plot, include=FALSE, message=FALSE}
fig3 <- loss %>% 
  ggplot(aes(x = pct, y = reorder(race_eth3, pct), color = zipcode)) +
  geom_errorbar(aes(xmin = lower, xmax = upper), show.legend = F, width = 0.1) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 7, color = "gray10", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(limits = c(0, .6), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)),
         size = FALSE) +
  labs(y = NULL, x = NULL, color = NULL, size = NULL,
       subtitle = "B) Income loss by race and ethnicity") +
  theme_classic() +
  themeuf + theme(axis.text.y = element_blank(), legend.position = "bottom")

ggsave(filename = "figure_3.png", plot = last_plot(), path = "~/GitHub/saetus/", width = 6, height = 4.5, units = "in", dpi = "print")


new.fig2 <- fig2 + fig3 + 
  plot_annotation(title = "Figure 2. Employment status and loss of employment by race and ethnicity",
                                          caption = "Source: 2021 San Antonio Energy and Time Use Survey", 
                                          theme = themeuf) +
  plot_layout(guides = "collect") & theme(legend.position = "bottom")

ggsave(filename = "figure_new_2.png", plot = last_plot(), path = "~/GitHub/saetus/", 
       width = 6, height = 4.5, units = "in", dpi = "print")
```

<center> <h2>Average number of welfare receipt by race and ethnicity and by neighborhood</h2> </center> 
<br>
```{r ave_welfare_plot, message=FALSE, warning=FALSE}
welfare$race_eth3 <- factor(welfare$race_eth3, ordered = F)
welfare$order <- c(1, 2, 3, 1, 2, 3)

welfare %>%
  ggplot(aes(x = average_welfare, y = reorder(race_eth3, -order), color = zipcode)) + 
  geom_point(aes(size = n)) +
  geom_text_repel(aes(label = round(average_welfare, 2)), 
                  size = 7, color = "gray10", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(breaks = seq(1, 2, .1), limits = c(1.5, 2)) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)),
         size = FALSE) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Figure 3. Average number of welfare benefits by race and ethnicity", 
       subtitle = str_wrap("Have you, or has anyone in your household received any type of welfare benefit?"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() + 
  themeuf

ggsave(filename = "figure_4.png", plot = last_plot(), path = "~/GitHub/saetus/", width = 6, height = 4.5, units = "in", dpi = "print")
```

<center> <h2>Material hardships by type and by neighborhood</h2> </center> 
<br>
```{r hardships_plots, message=FALSE}
hardships <- hardships %>% filter(hardships != "No difficulty") %>%  arrange(zipcode)

hardships$lower <- c(lower1, lower2, lower3, lower4, lower5, lower6, lower1b, lower2b, lower3b, lower4b, lower5b, lower6b)  
hardships$upper <- c(upper1, upper2, upper3, upper4, upper5, upper6, upper1b, upper2b, upper3b, upper4b, upper5b, upper6b)  

# hardships %>% 
#   filter(hardships != "Job loss") %>% 
#   ggplot(aes(x = pct, y = reorder(hardships, pct), color = zipcode)) +
#   geom_errorbar(aes(xmin = lower, xmax = upper), show.legend = F, width = 0.15) +
#   geom_point(stat = "identity", aes(size = n)) +
#   geom_text_repel(aes(label = lbl), size = 7, color = "gray10", segment.alpha = 0, family = "foo", nudge_y = .3) +
#   scale_x_continuous(limits = c(0, .45), breaks = seq(0, 1, .15), label = scales::percent) +
#   scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
#   guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), 
#          size = F) +
#   labs(y = NULL, x = NULL, color = NULL,
#        title = "Figure 5. Material hardships experienced by zip code", 
#        subtitle = str_wrap("Since the onset of COVID-19 (March 2020), have you, or has anyone in your household experienced any of the following material hardships"),
#        caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
#   theme_classic() +
#   themeuf

#ggsave(filename = "figure_5.png", plot = last_plot(), path = "~/GitHub/saetus/", width = 6, height = 4.5, units = "in", dpi = "print")

fig5 <- hardships %>% 
  ggplot(aes(x = pct, y = reorder(hardships, pct), color = zipcode)) +
  geom_errorbar(aes(xmin = lower, xmax = upper), show.legend = F, width = 0.1) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 7, color = "gray10", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .02) +
  scale_x_continuous(limits = c(0, .75), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), 
         size = F) +
  labs(y = NULL, x = NULL, color = NULL,
       subtitle = str_wrap("A) Type of hardship")) +
  theme_classic() +
  themeuf + theme(legend.position = "bottom", plot.subtitle = element_text(hjust = 0))

ggsave(filename = "figure_6.png", plot = last_plot(), path = "~/GitHub/saetus/", width = 6, height = 4.5, units = "in", dpi = "print")

fig6 <- bad %>%
  ggplot(aes(x = pct, y = reorder(bad, pct), color = zipcode)) +
  geom_errorbar(aes(xmin = lower, xmax = upper), show.legend = F, width = 0.1) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 7, color = "gray10", segment.alpha = 0, family = "foo", nudge_y = .2, nudge_x = .02) +
  scale_x_continuous(limits = c(0, .7), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), 
         size = F) +
  labs(y = NULL, x = NULL, color = NULL,
       subtitle = str_wrap("B) Number of hardships")) +
  theme_classic() +
  themeuf + theme(legend.position = "bottom", plot.subtitle = element_text(hjust = 0))

ggsave(filename = "figure_7.png", plot = last_plot(), path = "~/GitHub/saetus/", width = 6, height = 4.5, units = "in", dpi = "print")

new.fig4 <- fig5 / fig6 + 
  plot_annotation(title = "Figure 4. Material hardships experienced by zip code",
                                          caption = "Source: 2021 San Antonio Energy and Time Use Survey", 
                                          theme = themeuf) +
  plot_layout(guides = "collect") & theme(legend.position = "bottom")

ggsave(filename = "figure_new_4.png", plot = last_plot(), path = "~/GitHub/saetus/", 
       width = 6, height = 8, units = "in", dpi = "print")
```

```{r, include=FALSE, message=FALSE}
loss.1r <- data %>% 
  filter(!is.na(hardships_1)) %>% 
  rename(hardships = hardships_1) %>% 
  group_by(zipcode, hardships, race_eth3) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Job loss", 
                               if_else(hardships == 0, "No difficulty", "NA"))) 

loss.2r <- data %>% 
  filter(!is.na(hardships_2)) %>% 
  rename(hardships = hardships_2) %>% 
  group_by(zipcode, hardships, race_eth3) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Paying utility bills", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.3r <- data %>% 
  filter(!is.na(hardships_3)) %>% 
  rename(hardships = hardships_3) %>% 
  group_by(zipcode, hardships, race_eth3) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Affording food", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.4r <- data %>% 
  filter(!is.na(hardships_4)) %>% 
  rename(hardships = hardships_4) %>% 
  group_by(zipcode, hardships, race_eth3) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Paying rent/mortgage", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.5r <- data %>% 
  filter(!is.na(hardships_5)) %>% 
  rename(hardships = hardships_5) %>% 
  group_by(zipcode, hardships, race_eth3) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Paying medical bills", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.6r <- data %>% 
  filter(!is.na(hardships_6)) %>% 
  rename(hardships = hardships_6) %>% 
  group_by(zipcode, hardships, race_eth3) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Delay getting medical care", 
                               if_else(hardships == 0, "No difficulty", "NA")))  


hardships.r <- rbind(loss.1r, loss.2r, loss.3r, loss.4r, loss.5r, loss.6r)
```

```{r plots_2, message=FALSE, warning=FALSE}
hardships.r %>% 
  filter(hardships != "No difficulty") %>% 
  ggplot(aes(x = pct, y = reorder(hardships, -pct), color = race_eth3)) +
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 4.5, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .25, nudge_x = .025) +
  scale_x_continuous(limits = c(0, .65), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), 
         size = F) +
  facet_grid(~zipcode) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Type of hardship experienced by race and ethnicity", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), have you, or has anyone in your household experienced any of the following hardships"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf + theme(legend.position = "top")

data %>%
  filter(!is.na(bad)) %>% 
  group_by(zipcode, bad, race_eth3) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1)) %>% 
  ggplot(aes(x = pct, y = reorder(race_eth3, pct), color = zipcode)) +
  geom_point(aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 5, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .2, nudge_x = .01) +
  scale_x_continuous(limits = c(0, .75), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), 
         size = F) +
  facet_grid(~bad, scales = "free") +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Number of hardships by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), have you, or has anyone in your household experienced any type of hardships"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf + theme(axis.text.x = element_text(color = "gray40", size = 18))
```

<center> <h1>Conclusions</h1> </center> 
<br>

These disproportionate social and economic impacts following COVID-19 reflect harsh, longstanding inequalities in employment and other spheres of social life. 
Policy implications:













