---
title: "brief1"
author: "..."
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libs, message=FALSE, include=FALSE}
library(ggplot2)
library(ggrepel)
library(dplyr)
library(kableExtra)
library(summarytools)
library(ggsci)
library(wesanderson)
library(stringr)
```

```{r load, include=FALSE}
load(file = "~/GitHub/saetus/data_recode.RData")

data <- data %>% 
  mutate_at(vars(hardships_1:hardships_6), funs(recode(., "Yes" = as.numeric(1), "No" = as.numeric(0)))) %>% 
  mutate(hards = hardships_1 + hardships_2 + hardships_3 + hardships_4 + hardships_5 + hardships_6, 
         race_eth2 = case_when(race_eth %in% "NH-White" ~ "Non-Hispanic White",
                               race_eth %in% "Hispanic" ~ "Hispanic",
                               race_eth %in% "NH-Black" ~ "Non-Hispanic Black",
                               race_eth %in% "NH-Asian" ~ "Non-Hispanic Asian",
                               race_eth %in% c("NH-AIAN", "NH-NHPI", "NH-Other") ~ "Non-Hispanic Other"),
         bad = if_else(hards == 1, "One hardship", 
                       if_else(hards == 2, "Two hardships",
                               if_else(hards > 2, "More than two", NA_character_))))

data$bad <- ordered(data$bad, levels = c("One hardship", "Two hardships", "More than two"))
data$race_eth <- ordered(data$race_eth, levels = c("Hispanic", "NH-White", "NH-Black", "NH-Asian", "NH-AIAN", "NH-NHPI", "NH-Other"))
data$race_eth2 <- ordered(data$race_eth2, 
                          levels = c("Hispanic", "Non-Hispanic White", "Non-Hispanic Black", "Non-Hispanic Asian","Non-Hispanic Other"))
data$health <- ordered(data$health, levels = c("Excellent", "Very good", "Good", "Fair", "Poor"))
```

```{r themeu, include=FALSE, message=FALSE, warning=FALSE}
sysfonts::font_add_google(name = 'Lato', family = "foo")
showtext::showtext_auto()

themeu <- theme(legend.position = "bottom", 
                legend.text = element_text(size = 15, color = "gray40"), 
                legend.key.size = unit(.5, "cm"),
                panel.background = element_rect(colour = "black"),
                plot.title = element_text(face = "bold", size = 30, hjust = .5, vjust = .5, lineheight = .5), 
                plot.caption = element_text(size = 15),
                plot.subtitle = element_text(colour = "gray50", face = "bold", size = 22, lineheight = .5, hjust = .5, vjust = .5),
                axis.text = element_text(size = 20), 
                text = element_text(family = "foo"))

themeuf <- theme(legend.position = "top", 
                legend.text = element_text(size = 17, color = "gray40"), 
                legend.key.size = grid::unit(.5, "cm"), 
                legend.title = element_text(color = "gray40", face = "bold", size = 17), 
                panel.background = element_rect(colour = "black"),
                plot.title = element_text(face = "bold", size = 30, hjust = .5, vjust = .5, lineheight = .5), 
                plot.caption = element_text(size = 15),
                plot.subtitle = element_text(colour = "gray50", face = "bold", size = 22, lineheight = .5, hjust = .5, vjust = .5),
                axis.text = element_text(size = 20),
                strip.text = element_text(size = 20), 
                axis.title.x = element_text(color = "gray40", size = 20), 
                panel.grid.major.x = element_blank(),
                panel.grid.minor.x = element_blank(),
                panel.grid.major.y = element_line(colour = "grey70", linetype = "dotted"),
                text = element_text(family = "foo"))
```

# Hardships

Loss of employment became a major economic shock to many families and individuals who experienced it or are still experiencing it. Since the onset of the COVID-19 pandemic, unemployment in the United States has reached record highs.

In the summer of 2020, the Household Pulse Survey showed that in the United States, 126, 554, 411 people (51.1% of the adult population) had experienced loss of employment income. In Texas they were 11, 384, 721 (53.5%), and in the two metropolitan areas of this state that were considered, Dallas-Forth Worth-Arlington and Houston-The Woodlands-Sugar Land, they were 3, 002, 219 (56.3%) and 3, 687, 668 (59.2%), respectively.

The **San Antonio Energy and Time Use Survey** is an online survey that was answered between March 22-24 by residents of zip codes 78230 (referred to as **Elm Creek**) and 78202 (referred to as **Jefferson Heights**). With the information obtained from this source, we present a snapshot of the employment loss hardships experienced by these San Antonio residents. 

Since the onset of COVID-19 (March 2020), **57.4%** experienced the loss of employment income. This figure was **60% in Elm Creek** and **40% in Jefferson Heights**. Figure 1 also shows the percentage of residents by race and ethnicity who experienced job loss. 


```{r, include=FALSE, eval=FALSE}
round(prop.table(table(data$bad, data$depen), 1)*100, 1)

round(prop.table(table(data$zipcode, data$bad), 1)*100, 1)

round(prop.table(table(data$hardships_1, data$zipcode), 1)*100, 1)
```

```{r loss_income, include=FALSE, message=FALSE}
loss <- data %>%
  filter(hardships_1 == 1) %>% 
  group_by(zipcode, race_eth2) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1)) 

data %>%
  filter(hardships_1 == 1) %>% 
  group_by(zipcode) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1)) 
```

```{r plot_loss_income}
loss %>% 
  ggplot(aes(x = zipcode, y = pct, fill = race_eth2)) + 
  geom_bar(stat = "identity", position = "dodge", color = "gray30") +
  geom_text(aes(label = lbl), size = 6.5, color = "gray30", position = position_dodge(width = .9), vjust = -.7, family = "foo") +
  scale_y_continuous(limits = c(0, .60), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_fill_jama() +
  labs(y = NULL, x = NULL, fill = NULL,
       title = "Figure 1. Loss of employment distribution by race and ethnicity", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeu

loss %>% 
  ggplot(aes(x = pct, y = reorder(race_eth2, pct), color = zipcode)) +
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(limits = c(0, .5), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Figure 1. Loss of employment distribution by race and ethnicity", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

loss %>% 
  ggplot(aes(x = pct, y = reorder(race_eth2, pct), color = zipcode)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(limits = c(0, .5), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1),
         size = FALSE) +
  labs(y = NULL, x = NULL, color = NULL, size = NULL,
       title = "Figure 1. Loss of employment distribution by race and ethnicity", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf
```

## Loss of employment and health

The impacts of the pandemic are particularly prevalent among African American, Latinx, indigenous, and immigrant households. One representation of long-standing inequalities and an orderly system that reinforces the inequality gap between the different groups.

In many cases, job loss also represents loss of main income for the household, specially in households with dependents. In such cases, paying for the necessary food, the utility bills or rent/mortgage, can turn dramatically into more hardships to deal with during this pandemic.

An adequate state of health would be difficult to achieve under these conditions. In Figure 2 we show the self-reported health status among those respondents who lost their jobs.

```{r days_health, include=FALSE, message=FALSE}
lossxhealth <- data %>%
  filter(hardships_1 == 1) %>% 
  group_by(zipcode, health) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1)) 

lossxhealth2 <- data %>%
  filter(hardships_1 == 1) %>% 
  group_by(zipcode, race_eth2, depen) %>%
  summarize(ph.mean = round(mean(physical_health), 1),
            mh.mean = round(mean(mental_health), 1),
            n = n()) 
```

```{r plot_days_health}
lossxhealth %>% 
  ggplot(aes(x = zipcode, y = pct, fill = health)) + 
  geom_bar(stat = "identity", position = "dodge", color = "gray30") +
  geom_text(aes(label = lbl), size = 7, color = "gray30", position = position_dodge(width = .9), vjust = -.7, family = "foo") +
  scale_y_continuous(limits = c(0, .60), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_fill_manual(values = wes_palette(name = "Zissou1", n = 5)) +
  labs(y = NULL, 
       fill = NULL,
       x = NULL, 
       title = str_wrap("Figure 2. Self-rated health status distribution among those who lost their job", width = 60), 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeu

lossxhealth %>% 
  ggplot(aes(color = zipcode, x = pct, y = health)) + 
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(limits = c(0, .5), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_y_discrete(limits = rev(levels(data$health))) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = str_wrap("Figure 2. Self-rated health status distribution among those who lost their job", width = 60), 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

lossxhealth %>% 
  ggplot(aes(color = zipcode, x = pct, y = health)) + 
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(limits = c(0, .5), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_y_discrete(limits = rev(levels(data$health))) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(size = FALSE) +
  labs(y = NULL, x = NULL, color = NULL,
       title = str_wrap("Figure 2. Self-rated health status distribution among those who lost their job", width = 60), 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf
```

## Loss of employment and health II

We present the average number of days with not good physical health and mental health among those who lost their job. 

```{r plot_days_health_ii}
lossxhealth2 %>% 
  mutate(label = ph.mean) %>% 
  ggplot(aes(x = ph.mean, y = reorder(race_eth2, ph.mean))) + 
  geom_line(color = "gray70", size = 1) +
  geom_point(aes(color = depen, size = n), shape = 19) +
  facet_grid(~zipcode) +
  geom_text_repel(aes(label = label, x = ph.mean), size = 6, color = "gray30", nudge_y = .31, segment.alpha = 0, family = "foo") +
  scale_color_igv(palette = "alternating") +
  scale_x_continuous(limits = c(0, 5), breaks = seq(0, 5, 1)) +
  guides(color = guide_legend(label.position = "left", title.position = "left")) +
  labs(y = NULL, 
       color = "Do you have any dependents?",
       x = "Number of days",
       title = str_wrap("For how many days during the past 30 days was your physical health not good?", width = 50), 
       subtitle = str_wrap("We show the average number of days without good physical health by race and ethnicity", width = 65),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() + 
  themeuf 

lossxhealth2 %>% 
  mutate(label = mh.mean) %>% 
  ggplot(aes(x = mh.mean, y = reorder(race_eth2, mh.mean))) + 
  geom_line(color = "gray70", size = 1) +
  geom_point(aes(color = depen, size = n), shape = 19) +
  facet_grid(~zipcode) +
  geom_text_repel(aes(label = label, x = mh.mean), size = 6, color = "gray30", nudge_y = .31, segment.alpha = 0, family = "foo") +
  scale_color_igv(palette = "alternating") +
  scale_x_continuous(limits = c(0, 12), breaks = seq(0, 12, 2)) +
  guides(color = guide_legend(label.position = "left", title.position = "left")) +
  labs(y = NULL,  
       x = "Number of days", 
       color = "Do you have any dependents?",
       title = str_wrap("For how many days during the past 30 days was your mental health not good?", width = 50), 
       subtitle = str_wrap("We show the average number of days without good mental health by race and ethnicity", width = 65),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf
```

## Loss of employment and health III

We present the average number of days with not good physical health and mental health among those who lost their job and experienced two more hardships like difficulty in paying utility bills, in affording the kinds of food you need, in paying next rent or mortgage payment, in paying medical bill/health insurance, add delay getting/Do not get medical care or prescription medication. 

```{r, message=FALSE}
lossxbad2 <- data %>% 
  filter(bad == "More than two", hardships_1 == 1) %>% 
  group_by(zipcode, race_eth2, depen) %>%
  summarize(ph.mean = round(mean(physical_health), 1),
            mh.mean = round(mean(mental_health), 1),
            n = n()) 

lossxbad2 %>% 
  mutate(label = ph.mean) %>% 
  ggplot(aes(x = ph.mean, y = reorder(race_eth2, ph.mean))) + 
  geom_line(color = "gray70", size = 1) +
  geom_point(aes(color = depen, size = n), shape = 19) +
  facet_grid(~zipcode) +
  geom_text(aes(label = label, x = ph.mean), size = 6, color = "gray30", nudge_y = .3) +
  scale_color_igv(palette = "alternating") +
  scale_x_continuous(limits = c(0, 7), breaks = seq(0, 7, 1)) +
  guides(color = guide_legend(label.position = "left", title.position = "left")) +
  labs(y = NULL, x = "Number of days", 
       color = "Do you have any dependents?",
       title = str_wrap("For how many days during the past 30 days was your physical health not good?", width = 50), 
       subtitle = str_wrap("We show the average number of days without good physical health by race and ethnicity among those with more than two hardships",
                           width = 65),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

lossxbad2 %>% 
  mutate(label = mh.mean) %>% 
  ggplot(aes(x = mh.mean, y = reorder(race_eth2, mh.mean))) + 
  geom_line(color = "gray70", size = 1) +
  geom_point(aes(color = depen, size = n), shape = 19) +
  facet_grid(~zipcode) +
  geom_text_repel(aes(label = label, x = mh.mean), size = 6, color = "gray30", nudge_y = .3, segment.alpha = 0) +
  scale_color_igv(palette = "alternating") +
  scale_x_continuous(limits = c(0, 15), breaks = seq(0, 15, 3)) +
  guides(color = guide_legend(label.position = "left", title.position = "left"), 
         size = FALSE) +
  labs(y = NULL, x = "Number of days", 
       color = "Do you have any dependents?",
       title = str_wrap("For how many days during the past 30 days was your mental health not good?", width = 50), 
       subtitle = str_wrap("We show the average number of days without good mental health by race and ethnicity among those with more than two hardships",
                           width = 65),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf
```

```{r, include=FALSE}
h1 <- data %>% 
  select(zipcode, hardships_1:hardships_6, age:bad) %>% 
  filter(bad == "One hardship") 

h2 <- data %>% 
  select(zipcode, hardships_1:hardships_6, age:bad) %>% 
  filter(bad == "Two hardships") 

h3 <- data %>% 
  select(zipcode, hardships_1:hardships_6, age:bad) %>% 
  filter(bad == "More than two") 
####################
h11 <- h1 %>% 
  group_by(zipcode) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))
h12 <- h1 %>% 
  group_by(zipcode, gender2) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))

h21 <- h2 %>% 
  group_by(zipcode) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))
h22 <- h2 %>% 
  group_by(zipcode, gender2) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))

h31 <- h3 %>% 
  group_by(zipcode) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))
h32 <- h3 %>% 
  group_by(zipcode, gender2) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))
####################
h11 <- h11 %>%  
  tidyr::pivot_longer(cols = 2:7, names_to = "hard", values_to = "mean")
h12 <- h12 %>%  
  tidyr::pivot_longer(cols = 3:8, names_to = "hard", values_to = "mean")

h21 <- h21 %>%  
  tidyr::pivot_longer(cols = 2:7, names_to = "hard", values_to = "mean")
h22 <- h22 %>%  
  tidyr::pivot_longer(cols = 3:8, names_to = "hard", values_to = "mean")

h31 <- h31 %>%  
  tidyr::pivot_longer(cols = 2:7, names_to = "hard", values_to = "mean")
h32 <- h32 %>%  
  tidyr::pivot_longer(cols = 3:8, names_to = "hard", values_to = "mean")
####################
h11 <- h11 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))
h12 <- h12 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))

h21 <- h21 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))
h22 <- h22 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))

h31 <- h31 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))
h32 <- h32 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))
####################
h11$hard <- ordered(h11$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))
h12$hard <- ordered(h12$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))

h21$hard <- ordered(h21$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))
h22$hard <- ordered(h22$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))

h31$hard <- ordered(h31$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))
h32$hard <- ordered(h32$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))
```



## 1
```{r, include=FALSE, message=FALSE}
loss.1 <- data %>% 
  filter(!is.na(hardships_1)) %>% 
  rename(hardships = hardships_1) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Job loss", 
                               if_else(hardships == 0, "No difficulty", "NA"))) 

loss.2 <- data %>% 
  filter(!is.na(hardships_2)) %>% 
  rename(hardships = hardships_2) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Paying utility bills", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.3 <- data %>% 
  filter(!is.na(hardships_3)) %>% 
  rename(hardships = hardships_3) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Affording foods", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.4 <- data %>% 
  filter(!is.na(hardships_4)) %>% 
  rename(hardships = hardships_4) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Paying rent/mortgage", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.5 <- data %>% 
  filter(!is.na(hardships_5)) %>% 
  rename(hardships = hardships_5) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Paying medical bills", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.6 <- data %>% 
  filter(!is.na(hardships_6)) %>% 
  rename(hardships = hardships_6) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Delay getting medical care", 
                               if_else(hardships == 0, "No difficulty", "NA")))  


hardships <- rbind(loss.1, loss.2, loss.3, loss.4, loss.5, loss.6)
```

```{r plots_1}
loss.1 %>% 
  ggplot(aes(x = pct, y = reorder(hardships, pct), color = zipcode)) +
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .02) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Loss of employment distribution by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

loss.2 %>% 
  ggplot(aes(x = pct, y = reorder(hardships, pct), color = zipcode)) +
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .02) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Difficulty in paying utility bills by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced difficulties their paying utility bills"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

loss.3 %>% 
  ggplot(aes(x = pct, y = reorder(hardships, pct), color = zipcode)) +
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .02) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Difficulty in affording the kinds of food you need by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced difficulties affording the food you need"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

loss.4 %>% 
  ggplot(aes(x = pct, y = reorder(hardships, pct), color = zipcode)) +
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .02) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Difficulty in paying next rent or mortgage payment by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced difficulties paying rent or mortgage"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

loss.5 %>% 
  ggplot(aes(x = pct, y = reorder(hardships, pct), color = zipcode)) +
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .02) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Difficulty in paying medical bill/health insurance by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced difficulties paying medical bills"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

loss.6 %>% 
  ggplot(aes(x = pct, y = reorder(hardships, pct), color = zipcode)) +
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .02) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Delay getting medical care or prescription medication by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced delay getting medical care or prescription medication"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

hardships %>% 
  filter(hardships != "No difficulty") %>% 
  ggplot(aes(x = pct, y = reorder(hardships, pct), color = zipcode)) +
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(limits = c(0, .8), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Loss of employment distribution by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), have you, or has anyone in your household experienced any of the following hardships"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

data %>%
  filter(!is.na(bad)) %>% 
  group_by(zipcode, bad) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1)) %>% 
  ggplot(aes(x = pct, y = reorder(bad, pct), color = zipcode)) +
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(limits = c(0, .8), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Number of hardships by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), have you, or has anyone in your household experienced any type of hardships"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf
```

## 2
```{r, include=FALSE, message=FALSE}
loss.1r <- data %>% 
  filter(!is.na(hardships_1)) %>% 
  rename(hardships = hardships_1) %>% 
  group_by(zipcode, hardships, race_eth2) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Job loss", 
                               if_else(hardships == 0, "No difficulty", "NA"))) 

loss.2r <- data %>% 
  filter(!is.na(hardships_2)) %>% 
  rename(hardships = hardships_2) %>% 
  group_by(zipcode, hardships, race_eth2) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Paying utility bills", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.3r <- data %>% 
  filter(!is.na(hardships_3)) %>% 
  rename(hardships = hardships_3) %>% 
  group_by(zipcode, hardships, race_eth2) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Affording foods", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.4r <- data %>% 
  filter(!is.na(hardships_4)) %>% 
  rename(hardships = hardships_4) %>% 
  group_by(zipcode, hardships, race_eth2) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Paying rent/mortgage", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.5r <- data %>% 
  filter(!is.na(hardships_5)) %>% 
  rename(hardships = hardships_5) %>% 
  group_by(zipcode, hardships, race_eth2) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Paying medical bills", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.6r <- data %>% 
  filter(!is.na(hardships_6)) %>% 
  rename(hardships = hardships_6) %>% 
  group_by(zipcode, hardships, race_eth2) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Delay getting medical care", 
                               if_else(hardships == 0, "No difficulty", "NA")))  


hardships.r <- rbind(loss.1r, loss.2r, loss.3r, loss.4r, loss.5r, loss.6r)
```

```{r plots_1}
loss.1r %>% 
  ggplot(aes(x = pct, y = reorder(race_eth2, pct), color = hardships)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .02) +
  scale_x_continuous(limits = c(0, .60), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 5)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  facet_grid(~zipcode) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Loss of employment distribution by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

loss.2r %>% 
  ggplot(aes(x = pct, y = reorder(race_eth2, pct), color = hardships)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .02) +
  scale_x_continuous(limits = c(0, .60), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 5)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  facet_grid(~zipcode) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Difficulty in paying utility bills by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced difficulties their paying utility bills"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

loss.3r %>% 
  ggplot(aes(x = pct, y = reorder(race_eth2, pct), color = hardships)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .02) +
  scale_x_continuous(limits = c(0, .60), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 5)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  facet_grid(~zipcode) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Difficulty in affording the kinds of food you need by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced difficulties affording the food you need"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

loss.4r %>% 
  ggplot(aes(x = pct, y = reorder(race_eth2, pct), color = hardships)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .02) +
  scale_x_continuous(limits = c(0, .60), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 5)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  facet_grid(~zipcode) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Difficulty in paying next rent or mortgage payment by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced difficulties paying rent or mortgage"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

loss.5r %>% 
  ggplot(aes(x = pct, y = reorder(race_eth2, pct), color = hardships)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .02) +
  scale_x_continuous(limits = c(0, .60), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 5)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  facet_grid(~zipcode) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Difficulty in paying medical bill/health insurance by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced difficulties paying medical bills"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

loss.6r %>% 
  ggplot(aes(x = pct, y = reorder(race_eth2, pct), color = hardships)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .02) +
  scale_x_continuous(limits = c(0, .60), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 5)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  facet_grid(~zipcode) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Delay getting medical care or prescription medication by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced delay getting medical care or prescription medication"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

hardships.r %>% 
  filter(hardships != "No difficulty") %>% 
  ggplot(aes(x = pct, y = reorder(hardships, -pct), color = race_eth2)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(limits = c(0, .7), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Zissou1", n = 5)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  facet_grid(~zipcode) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Loss of employment distribution by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), have you, or has anyone in your household experienced any of the following hardships"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf + theme(legend.position = "bottom")

data %>%
  filter(!is.na(bad)) %>% 
  group_by(zipcode, race_eth2, bad) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1)) %>% 
  ggplot(aes(x = pct, y = reorder(race_eth2, -pct), color = zipcode)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(limits = c(0, .9), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  facet_grid(~bad) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Number of hardships by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), have you, or has anyone in your household experienced any type of hardships"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf
```







































