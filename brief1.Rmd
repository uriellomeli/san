---
title: "brief1"
author: "..."
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libs, message=FALSE, include=FALSE}
library(nationalparkcolors)
library(treemapify)
library(ggplot2)
library(dplyr)
library(kableExtra)
library(summarytools)
```

```{r load, include=FALSE}
load(file = "~/GitHub/saetus/data_recode.RData")

data <- data %>% 
  mutate_at(vars(hardships_1:hardships_6), funs(recode(., "Yes" = as.numeric(1), "No" = as.numeric(0)))) %>% 
  mutate(hards = hardships_1+hardships_2+hardships_3+hardships_4+hardships_5+hardships_6, 
         bad = if_else(hards == 1, "One hardship", 
                       if_else(hards == 2, "Two hardships",
                               if_else(hards > 2, "More than two", NA_character_))))

data$bad <- ordered(data$bad, levels = c("One hardship", "Two hardships", "More than two"))
```

```{r themeu, include=FALSE, message=FALSE, warning=FALSE}
sysfonts::font_add_google(name = "Barlow", family = "foo")
showtext::showtext_auto()

names(park_palettes)
park <- park_palette("Acadia", n = 3)
park2 <- park_palette("Redwoods", n = 5)
park3 <- park_palette("GeneralGrant", n = 7)
```

## Hardships

Since the onset of COVID-19 (March 2020), have you, or has anyone in your household experienced any of the following hardships: 
  
  Loss of employment income   
  Difficulty in paying utility bills (electricity, gas, cellphone, internet)   
  Difficulty in affording the kinds of food you need   
  Difficulty in paying next rent or mortgage payment   
  Difficulty in paying medical bill/health insurance 
  Delay getting/Do not get medical care or prescription medication

```{r, include=FALSE, eval=FALSE}
round(prop.table(table(data$bad, data$depen), 1)*100, 1)

round(prop.table(table(data$zipcode, data$bad), 1)*100, 1)

xtabs(formula = ~zipcode + bad + gender2, data = data, subset = data$gender2!="Other")

table(data$hardships_1)
```

```{r, include=FALSE, message=FALSE}
loss <- data %>%
  filter(hardships_1 == 1) %>% 
  group_by(zipcode, race_eth) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1)) 

loss %>% 
  ggplot(aes(x = zipcode, y = pct, fill = race_eth)) + 
  geom_bar(stat = "identity", position = "dodge", color = "gray30") +
  geom_text(aes(label = lbl), size = 3, color = "gray30", position = position_dodge(width = .9), vjust = -.7) +
  scale_y_continuous(breaks = seq(0, 1, .15), label = scales::percent) +
  scale_fill_manual(values = park3) +
  labs(y = NULL, 
       fill = "Race and Ethnicity",
       x = NULL, 
       title = "Loss of employment income", 
       subtitle = "by race and ethnicity",
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  theme(legend.position = "right", 
        plot.title = element_text(face = "bold"), 
        plot.caption = element_text(size = 8),
        plot.subtitle = element_text(colour = "gray50", face = "bold"), axis.text.x = element_text(face = "bold"))
```

```{r days_health, message=FALSE}
lossxhealth <- data %>%
  filter(hardships_1 == 1) %>% 
  group_by(zipcode, health) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1)) 

lossxhealth2 <- data %>%
  filter(hardships_1 == 1) %>% 
  group_by(zipcode, race_eth, depen) %>%
  summarize(ph.mean = round(mean(physical_health), 1),
            mh.mean = round(mean(mental_health), 1)) 
```

```{r plot_days_health}
lossxhealth %>% 
  ggplot(aes(x = zipcode, y = pct, fill = health)) + 
  geom_bar(stat = "identity", position = "dodge", color = "gray30") +
  geom_text(aes(label = lbl), size = 3, color = "gray30", position = position_dodge(width = .9), vjust = -.7) +
  scale_y_continuous(breaks = seq(0, 1, .15), label = scales::percent) +
  scale_fill_manual(values = park3) +
  labs(y = NULL, 
       fill = "Health status",
       x = NULL, 
       title = "Loss of employment income", 
       subtitle = "by self-rated health",
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  theme(legend.position = "right", 
        plot.title = element_text(face = "bold"), 
        plot.caption = element_text(size = 8),
        plot.subtitle = element_text(colour = "gray50", face = "bold"), axis.text.x = element_text(face = "bold"))

lossxhealth2 %>% 
  mutate(label = ph.mean) %>% 
  ggplot(aes(x = ph.mean, y = race_eth)) + 
  geom_line(color = "gray60", size = 1) +
  geom_point(aes(color = depen), size = 4, shape = 19) +
  facet_grid(~zipcode) +
  geom_text(aes(label = label, x = ph.mean), nudge_y = 0.25, size = 3) +
  scale_color_manual(values = park) +
  labs(y = NULL, 
       color = "Dependents",
       x = NULL, 
       title = "Thinking about your physical health, for how many days during the past 30 days was your physical health not good?", 
       subtitle = "average number of days by race and ethnicity",
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  theme(legend.position = "bottom")

lossxhealth2 %>% 
  mutate(label = mh.mean) %>% 
  ggplot(aes(x = mh.mean, y = race_eth)) + 
  geom_line(color = "gray60", size = 1) +
  geom_point(aes(color = depen), size = 4, shape = 19) +
  facet_grid(~zipcode) +
  geom_text(aes(label = label, x = mh.mean), nudge_y = 0.25, size = 3) +
  scale_color_manual(values = park) +
  labs(y = NULL, 
       color = "Dependents",
       x = NULL, 
       title = "Thinking about your mental health, for how many days during the past 30 days was your mental health not good?", 
       subtitle = "average number of days by race and ethnicity",
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  theme(legend.position = "bottom")
```


```{r}
lossxbad <- data %>% 
  filter(bad != "Two hardships") %>% 
  group_by(zipcode, bad, health) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1)) 

lossxbad %>% 
  ggplot(aes(x = bad, y = pct, fill = health)) + 
  geom_bar(stat = "identity", position = "dodge", color = "gray30") +
  geom_text(aes(label = lbl), size = 3, color = "gray30", position = position_dodge(width = .9), vjust = -.7) +
  facet_grid(~zipcode) +
  scale_y_continuous(breaks = seq(0, 1, .15), label = scales::percent) +
  scale_fill_manual(values = park3) +
  labs(y = NULL, 
       fill = "Race and Ethnicity",
       x = NULL, 
       title = "Loss of employment income", 
       subtitle = "by race and ethnicity",
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  theme(legend.position = "right", 
        plot.title = element_text(face = "bold"), 
        plot.caption = element_text(size = 8),
        plot.subtitle = element_text(colour = "gray50", face = "bold"), axis.text.x = element_text(face = "bold"))
```

```{r}
lossxbad2 <- data %>% 
  filter(bad == "More than two", hardships_1 == 1) %>% 
  group_by(zipcode, race_eth, depen) %>%
  summarize(ph.mean = round(mean(physical_health), 1),
            mh.mean = round(mean(mental_health), 1)) 

lossxbad2 %>% 
  mutate(label = ph.mean) %>% 
  ggplot(aes(x = ph.mean, y = race_eth)) + 
  geom_line(color = "gray60", size = 1) +
  geom_point(aes(color = depen), size = 4, shape = 19) +
  facet_grid(~zipcode) +
  geom_text(aes(label = label, x = ph.mean), nudge_y = 0.25, size = 3) +
  scale_color_manual(values = park) +
  labs(y = NULL, 
       color = "Dependents",
       x = NULL, 
       title = "Thinking about your mental health, for how many days during the past 30 days was your physical health not good?", 
       subtitle = "average number of days by race and ethnicity",
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  theme(legend.position = "bottom")

lossxbad2 %>% 
  mutate(label = mh.mean) %>% 
  ggplot(aes(x = mh.mean, y = race_eth)) + 
  geom_line(color = "gray60", size = 1) +
  geom_point(aes(color = depen), size = 4, shape = 19) +
  facet_grid(~zipcode) +
  geom_text(aes(label = label, x = mh.mean), nudge_y = 0.25, size = 3) +
  scale_color_manual(values = park) +
  labs(y = NULL, 
       color = "Dependents",
       x = NULL, 
       title = "Thinking about your mental health, for how many days during the past 30 days was your mental health not good?", 
       subtitle = "average number of days by race and ethnicity",
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  theme(legend.position = "bottom")
```

```{r, include=FALSE}
h1 <- data %>% 
  select(zipcode, hardships_1:hardships_6, age:bad) %>% 
  filter(bad == "One hardship") 

h2 <- data %>% 
  select(zipcode, hardships_1:hardships_6, age:bad) %>% 
  filter(bad == "Two hardships") 

h3 <- data %>% 
  select(zipcode, hardships_1:hardships_6, age:bad) %>% 
  filter(bad == "More than two") 
####################
h11 <- h1 %>% 
  group_by(zipcode) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))
h12 <- h1 %>% 
  group_by(zipcode, gender2) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))

h21 <- h2 %>% 
  group_by(zipcode) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))
h22 <- h2 %>% 
  group_by(zipcode, gender2) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))

h31 <- h3 %>% 
  group_by(zipcode) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))
h32 <- h3 %>% 
  group_by(zipcode, gender2) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))
####################
h11 <- h11 %>%  
  tidyr::pivot_longer(cols = 2:7, names_to = "hard", values_to = "mean")
h12 <- h12 %>%  
  tidyr::pivot_longer(cols = 3:8, names_to = "hard", values_to = "mean")

h21 <- h21 %>%  
  tidyr::pivot_longer(cols = 2:7, names_to = "hard", values_to = "mean")
h22 <- h22 %>%  
  tidyr::pivot_longer(cols = 3:8, names_to = "hard", values_to = "mean")

h31 <- h31 %>%  
  tidyr::pivot_longer(cols = 2:7, names_to = "hard", values_to = "mean")
h32 <- h32 %>%  
  tidyr::pivot_longer(cols = 3:8, names_to = "hard", values_to = "mean")
####################
h11 <- h11 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))
h12 <- h12 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))

h21 <- h21 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))
h22 <- h22 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))

h31 <- h31 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))
h32 <- h32 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))
####################
h11$hard <- ordered(h11$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))
h12$hard <- ordered(h12$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))

h21$hard <- ordered(h21$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))
h22$hard <- ordered(h22$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))

h31$hard <- ordered(h31$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))
h32$hard <- ordered(h32$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))
```

```{r plots_1}
h11 %>% 
  mutate(label = scales::percent(mean, accuracy = 0.1)) %>% 
  ggplot(aes(x = hard, y = mean, fill = zipcode)) +
  geom_bar(stat = "identity", 
           position = "dodge", 
           color = "black") +
  geom_text(aes(y = mean, label = label), size = 3, color = "black", position = position_dodge(width = .9), vjust = -.5) +
  scale_fill_manual(values = park) +
  scale_y_continuous(breaks = seq(0, 1, .15), label = scales::percent) +
  labs(x = NULL, 
       y = NULL, 
       fill = NULL, 
       caption = "2021 San Antonio Energy and Time Use Survey", 
       title = "Hardship by zip code",
       subtitle = "Respondents with one hardship") +
  theme_classic() +
  theme(legend.position = c(.8, .8), legend.box.just = "right", legend.background = element_rect("gray95"), 
        plot.caption = element_text(size = 8), axis.text.x = element_text(size = 8), panel.background = element_rect("gray95"))

h21 %>% 
  mutate(label = scales::percent(mean, accuracy = 0.1)) %>% 
  ggplot(aes(x = hard, y = mean, fill = zipcode)) +
  geom_bar(stat = "identity", 
           position = "dodge", 
           color = "black") +
  geom_text(aes(y = mean, label = label), size = 3, color = "black", position = position_dodge(width = .9), vjust = -.5) +
  scale_fill_manual(values = park) +
  scale_y_continuous(breaks = seq(0, 1, .15), label = scales::percent) +
  labs(x = NULL, 
       y = NULL, 
       fill = NULL, 
       caption = "2021 San Antonio Energy and Time Use Survey", 
       title = "Hardship by zip code",
       subtitle = "Respondents with two hardships") +
  theme_classic() +
  theme(legend.position = c(.8, .8), legend.box.just = "right", legend.background = element_rect("gray95"), 
        plot.caption = element_text(size = 8), axis.text.x = element_text(size = 8), panel.background = element_rect("gray95"))

h31 %>% 
  mutate(label = scales::percent(mean, accuracy = 0.1)) %>% 
  ggplot(aes(x = hard, y = mean, fill = zipcode)) +
  geom_bar(stat = "identity", 
           position = "dodge", 
           color = "black") +
  geom_text(aes(y = mean, label = label), size = 3, color = "black", position = position_dodge(width = .9), vjust = -.5) +
  scale_fill_manual(values = park) +
  scale_y_continuous(breaks = seq(0, 1, .15), label = scales::percent) +
  labs(x = NULL, 
       y = NULL, 
       fill = NULL, 
       caption = "2021 San Antonio Energy and Time Use Survey", 
       title = "Hardship by zip code",
       subtitle = "Respondents with more than two hardship") +
  theme_classic() +
  theme(legend.position = c(.8, .8), legend.box.just = "right", legend.background = element_rect("gray95"), 
        plot.caption = element_text(size = 8), axis.text.x = element_text(size = 8), panel.background = element_rect("gray95"))
```


























