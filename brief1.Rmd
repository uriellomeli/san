---
title: "brief1"
author: "..."
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libs, message=FALSE, include=FALSE}
library(ggplot2)
library(ggrepel)
library(dplyr)
library(kableExtra)
library(summarytools)
library(ggsci)
library(wesanderson)
library(stringr)
```

```{r load, include=FALSE}
load(file = "~/GitHub/saetus/data_recode.RData")

data <- data %>% 
  mutate_at(vars(hardships_1:hardships_6), funs(recode(., "Yes" = as.numeric(1), "No" = as.numeric(0)))) %>% 
  mutate(hards = hardships_1+hardships_2+hardships_3+hardships_4+hardships_5+hardships_6, 
         race_eth2 = case_when(race_eth %in% "NH-White" ~ "Non-Hispanic White",
                               race_eth %in% "Hispanic" ~ "Hispanic",
                               race_eth %in% c("NH-Black", "NH-Asian", "NH-AIAN", "NH-NHPI", "NH-Other") ~ "Non-Hispanic Other"),
         bad = if_else(hards == 1, "One hardship", 
                       if_else(hards == 2, "Two hardships",
                               if_else(hards > 2, "More than two", NA_character_))))

data$bad <- ordered(data$bad, levels = c("One hardship", "Two hardships", "More than two"))
data$race_eth <- ordered(data$race_eth, levels = c("Hispanic", "NH-White", "NH-Black", "NH-Asian", "NH-AIAN", "NH-NHPI", "NH-Other"))
data$race_eth2 <- ordered(data$race_eth2, levels = c("Hispanic", "Non-Hispanic White", "Non-Hispanic Other"))
```

```{r themeu, include=FALSE, message=FALSE, warning=FALSE}
sysfonts::font_add_google(name = "Lato", family = "foo")
showtext::showtext_auto()

themeu <- theme(legend.position = "bottom", 
                legend.text = element_text(size = 15, color = "gray40"), 
                legend.key.size = unit(.5, "cm"),
                panel.background = element_rect(colour = "black"),
                plot.title = element_text(face = "bold", size = 30, hjust = .5, vjust = .5), 
                plot.caption = element_text(size = 15),
                plot.subtitle = element_text(colour = "gray50", face = "bold", size = 22, lineheight = .5, hjust = .5, vjust = .5),
                axis.text = element_text(size = 20))

themeuf <- theme(legend.position = "top", 
                legend.text = element_text(size = 15, color = "gray40"), 
                legend.key.size = unit(.5, "cm"),
                legend.title = element_text(color = "gray40", face = "bold", size = 15), 
                panel.background = element_rect(colour = "black"),
                plot.title = element_text(face = "bold", size = 30, hjust = .5, vjust = .5, lineheight = .5), 
                plot.caption = element_text(size = 15),
                plot.subtitle = element_text(colour = "gray50", face = "bold", size = 22, lineheight = .5, hjust = .5, vjust = .5),
                axis.text = element_text(size = 20),
                strip.text = element_text(size = 20), 
                axis.title.x = element_text(color = "gray40", size = 20))
```

## Hardships

Since the onset of COVID-19 (March 2020), have you, or has anyone in your household experienced any of the following hardships: 
  
  Loss of employment income   
  Difficulty in paying utility bills (electricity, gas, cellphone, internet)   
  Difficulty in affording the kinds of food you need   
  Difficulty in paying next rent or mortgage payment   
  Difficulty in paying medical bill/health insurance 
  Delay getting/Do not get medical care or prescription medication

```{r, include=FALSE, eval=FALSE}
round(prop.table(table(data$bad, data$depen), 1)*100, 1)

round(prop.table(table(data$zipcode, data$bad), 1)*100, 1)

xtabs(formula = ~zipcode + bad + gender2, data = data, subset = data$gender2!="Other")

table(data$hardships_1)
```

```{r loss_income, include=FALSE, message=FALSE}
loss <- data %>%
  filter(hardships_1 == 1) %>% 
  group_by(zipcode, race_eth) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1)) 

lossxrace2 <- data %>%
  filter(hardships_1 == 1) %>% 
  group_by(zipcode, race_eth2) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1)) 
```

```{r plot_loss_income}
loss %>% 
  ggplot(aes(x = zipcode, y = pct, fill = race_eth)) + 
  geom_bar(stat = "identity", position = "dodge", color = "gray30") +
  geom_text(aes(label = lbl), size = 6.5, color = "gray30", position = position_dodge(width = .9), vjust = -.7) +
  scale_y_continuous(limits = c(0, .60), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_fill_jama() +
  labs(y = NULL, x = NULL, fill = NULL,
       title = "Loss of employment distribution by race and ethnicity", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeu

lossxrace2 %>% 
  ggplot(aes(x = zipcode, y = pct, fill = race_eth2)) + 
  geom_bar(stat = "identity", position = "dodge", color = "gray30", width = .7) +
  geom_text(aes(label = lbl), size = 7, color = "gray30", position = position_dodge(width = .7), vjust = -.7) +
  scale_y_continuous(limits = c(0, .60), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_fill_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(fill = guide_legend(label.position = "right", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, fill = NULL,
       title = "Loss of employment distribution by race and ethnicity", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeu
```

```{r days_health, message=FALSE}
lossxhealth <- data %>%
  filter(hardships_1 == 1) %>% 
  group_by(zipcode, health) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1)) 

lossxhealth2 <- data %>%
  filter(hardships_1 == 1) %>% 
  group_by(zipcode, race_eth2, depen) %>%
  summarize(ph.mean = round(mean(physical_health), 1),
            mh.mean = round(mean(mental_health), 1)) 
```

```{r plot_days_health}
lossxhealth %>% 
  ggplot(aes(x = zipcode, y = pct, fill = health)) + 
  geom_bar(stat = "identity", position = "dodge", color = "gray30") +
  geom_text(aes(label = lbl), size = 7, color = "gray30", position = position_dodge(width = .9), vjust = -.7) +
  scale_y_continuous(limits = c(0, .60), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_fill_manual(values = wes_palette(name = "Zissou1", n = 5)) +
  labs(y = NULL, 
       fill = NULL,
       x = NULL, 
       title = "Loss of employment distribution by self-rated health status", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeu

lossxhealth2 %>% 
  mutate(label = ph.mean) %>% 
  ggplot(aes(x = ph.mean, y = race_eth2)) + 
  geom_line(color = "gray70", size = 2) +
  geom_point(aes(color = depen), size = 6, shape = 19) +
  facet_grid(~zipcode) +
  geom_text_repel(aes(label = label, x = ph.mean), size = 6, color = "gray30", nudge_y = .2, segment.alpha = 0) +
  scale_color_igv(palette = "alternating") +
  scale_x_continuous(limits = c(1, 4), breaks = seq(1, 4, 1)) +
  guides(color = guide_legend(label.position = "left", title.position = "left")) +
  labs(y = NULL, 
       color = "Do you have any dependents?",
       x = "Number of days",
       title = str_wrap("For how many days during the past 30 days was your physical health not good?", width = 50), 
       subtitle = str_wrap("We show the average number of days without good physical health by race and ethnicity", width = 65),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() + 
  themeuf 

lossxhealth2 %>% 
  mutate(label = mh.mean) %>% 
  ggplot(aes(x = mh.mean, y = race_eth2)) + 
  geom_line(color = "gray70", size = 2) +
  geom_point(aes(color = depen), size = 6, shape = 19) +
  facet_grid(~zipcode) +
  geom_text_repel(aes(label = label, x = mh.mean), size = 6, color = "gray30", nudge_y = .2, segment.alpha = 0) +
  scale_color_igv(palette = "alternating") +
  scale_x_continuous(limits = c(2, 6), breaks = seq(2, 6, 1)) +
  guides(color = guide_legend(label.position = "left", title.position = "left")) +
  labs(y = NULL,  
       x = "Number of days", 
       color = "Do you have any dependents?",
       title = str_wrap("For how many days during the past 30 days was your mental health not good?", width = 50), 
       subtitle = str_wrap("We show the average number of days without good mental health by race and ethnicity", width = 65),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf
```

```{r, message=FALSE}
lossxbad <- data %>% 
  filter(bad != "Two hardships") %>% 
  group_by(zipcode, bad, health) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1)) 

lossxbad %>% 
  ggplot(aes(x = bad, y = pct, fill = health)) + 
  geom_bar(stat = "identity", position = "dodge", color = "gray30", width = 1) +
  geom_text(aes(label = lbl), size = 6, color = "gray30", position = position_dodge(width = .9), vjust = -.5, hjust=.5) +
  facet_grid(~zipcode) +
  scale_y_continuous(limits = c(0, .60), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_fill_manual(values = wes_palette(name = "Zissou1", n = 5)) +
  guides(fill = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL,  x = NULL, fill = NULL,
       title = "Loss of employment distribution by health status", 
       subtitle = 
         str_wrap("We show the distribution of health status among those who have experienced one and three or more hardhips since the onset of COVID-19 (March 2020)"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeu + theme(strip.text = element_text(size = 20))
```

```{r, message=FALSE}
lossxbad2 <- data %>% 
  filter(bad == "More than two", hardships_1 == 1) %>% 
  group_by(zipcode, race_eth2, depen) %>%
  summarize(ph.mean = round(mean(physical_health), 1),
            mh.mean = round(mean(mental_health), 1)) 

lossxbad2 %>% 
  mutate(label = ph.mean) %>% 
  ggplot(aes(x = ph.mean, y = race_eth2)) + 
  geom_line(color = "gray70", size = 2) +
  geom_point(aes(color = depen), size = 6, shape = 19) +
  facet_grid(~zipcode) +
  geom_text(aes(label = label, x = ph.mean), size = 6, color = "gray30", nudge_y = .2) +
  scale_color_igv(palette = "alternating") +
  scale_x_continuous(limits = c(0, 7), breaks = seq(0, 7, 1)) +
  guides(color = guide_legend(label.position = "left", title.position = "left")) +
  labs(y = NULL, x = "Number of days", 
       color = "Do you have any dependents?",
       title = str_wrap("For how many days during the past 30 days was your physical health not good?", width = 50), 
       subtitle = str_wrap("We show the average number of days without good physical health by race and ethnicity among those with more than two hardships",
                           width = 65),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

lossxbad2 %>% 
  mutate(label = mh.mean) %>% 
  ggplot(aes(x = mh.mean, y = race_eth2)) + 
  geom_line(color = "gray70", size = 2) +
  geom_point(aes(color = depen), size = 6, shape = 19) +
  facet_grid(~zipcode) +
  geom_text_repel(aes(label = label, x = mh.mean), size = 6, color = "gray30", nudge_y = .2, segment.alpha = 0) +
  scale_color_igv(palette = "alternating") +
  scale_x_continuous(limits = c(0, 15), breaks = seq(0, 15, 3)) +
  guides(color = guide_legend(label.position = "left", title.position = "left")) +
  labs(y = NULL, x = "Number of days", 
       color = "Do you have any dependents?",
       title = str_wrap("For how many days during the past 30 days was your mental health not good?", width = 50), 
       subtitle = str_wrap("We show the average number of days without good mental health by race and ethnicity among those with more than two hardships",
                           width = 65),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf
```

```{r, include=FALSE}
h1 <- data %>% 
  select(zipcode, hardships_1:hardships_6, age:bad) %>% 
  filter(bad == "One hardship") 

h2 <- data %>% 
  select(zipcode, hardships_1:hardships_6, age:bad) %>% 
  filter(bad == "Two hardships") 

h3 <- data %>% 
  select(zipcode, hardships_1:hardships_6, age:bad) %>% 
  filter(bad == "More than two") 
####################
h11 <- h1 %>% 
  group_by(zipcode) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))
h12 <- h1 %>% 
  group_by(zipcode, gender2) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))

h21 <- h2 %>% 
  group_by(zipcode) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))
h22 <- h2 %>% 
  group_by(zipcode, gender2) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))

h31 <- h3 %>% 
  group_by(zipcode) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))
h32 <- h3 %>% 
  group_by(zipcode, gender2) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))
####################
h11 <- h11 %>%  
  tidyr::pivot_longer(cols = 2:7, names_to = "hard", values_to = "mean")
h12 <- h12 %>%  
  tidyr::pivot_longer(cols = 3:8, names_to = "hard", values_to = "mean")

h21 <- h21 %>%  
  tidyr::pivot_longer(cols = 2:7, names_to = "hard", values_to = "mean")
h22 <- h22 %>%  
  tidyr::pivot_longer(cols = 3:8, names_to = "hard", values_to = "mean")

h31 <- h31 %>%  
  tidyr::pivot_longer(cols = 2:7, names_to = "hard", values_to = "mean")
h32 <- h32 %>%  
  tidyr::pivot_longer(cols = 3:8, names_to = "hard", values_to = "mean")
####################
h11 <- h11 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))
h12 <- h12 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))

h21 <- h21 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))
h22 <- h22 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))

h31 <- h31 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))
h32 <- h32 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))
####################
h11$hard <- ordered(h11$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))
h12$hard <- ordered(h12$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))

h21$hard <- ordered(h21$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))
h22$hard <- ordered(h22$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))

h31$hard <- ordered(h31$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))
h32$hard <- ordered(h32$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))
```


























