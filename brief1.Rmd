---
title: "Socioeconomic and Health Outcomes of Residents in San Antonio During the COVID-19 Pandemic: Evidence from a Local Community Survey"
author: "..."
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    highlight: tango
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libs, message=FALSE, include=FALSE}
library(ggplot2)
library(ggrepel)
library(dplyr)
library(kableExtra)
library(summarytools)
library(ggsci)
library(wesanderson)
library(stringr)
```

```{r load, include=FALSE}
load(file = "~/GitHub/saetus/data_recode.RData")

data <- data %>% 
  mutate_at(vars(hardships_1:hardships_6), funs(recode(., "Yes" = as.numeric(1), "No" = as.numeric(0)))) %>% 
  mutate(hards = hardships_1 + hardships_2 + hardships_3 + hardships_4 + hardships_5 + hardships_6, 
         race_eth2 = case_when(race_eth %in% "NH-White" ~ "Non-Hispanic White",
                               race_eth %in% "Hispanic" ~ "Hispanic",
                               race_eth %in% "NH-Black" ~ "Non-Hispanic Black",
                               race_eth %in% "NH-Asian" ~ "Non-Hispanic Asian",
                               race_eth %in% c("NH-AIAN", "NH-NHPI", "NH-Other") ~ "Non-Hispanic Other"),
         bad = if_else(hards == 1, "One hardship", 
                       if_else(hards == 2, "Two hardships",
                               if_else(hards > 2, "More than two", NA_character_))))

data$bad <- ordered(data$bad, levels = c("One hardship", "Two hardships", "More than two"))
data$race_eth <- ordered(data$race_eth, levels = c("Hispanic", "NH-White", "NH-Black", "NH-Asian", "NH-AIAN", "NH-NHPI", "NH-Other"))
data$race_eth2 <- ordered(data$race_eth2, 
                          levels = c("Hispanic", "Non-Hispanic White", "Non-Hispanic Black", "Non-Hispanic Asian","Non-Hispanic Other"))
data$health <- ordered(data$health, levels = c("Excellent", "Very good", "Good", "Fair", "Poor"))
```

```{r themeu, include=FALSE, message=FALSE, warning=FALSE}
sysfonts::font_add_google(name = 'Lato', family = "foo")
showtext::showtext_auto()

themeu <- theme(legend.position = "bottom", 
                legend.text = element_text(size = 15, color = "gray40"), 
                legend.key.size = unit(.5, "cm"),
                panel.background = element_rect(colour = "black"),
                plot.title = element_text(face = "bold", size = 30, hjust = .5, vjust = .5, lineheight = .5), 
                plot.caption = element_text(size = 15),
                plot.subtitle = element_text(colour = "gray50", face = "bold", size = 22, lineheight = .5, hjust = .5, vjust = .5),
                axis.text = element_text(size = 20), 
                text = element_text(family = "foo"))

themeuf <- theme(legend.position = "top", 
                 legend.text = element_text(size = 17, color = "gray40"), 
                 legend.key.size = grid::unit(.5, "cm"), 
                 legend.title = element_text(color = "gray40", face = "bold", size = 17), 
                 panel.background = element_rect(colour = "black"),
                 plot.title = element_text(face = "bold", size = 30, hjust = .5, vjust = .5, lineheight = .5), 
                 plot.caption = element_text(size = 15),
                 plot.subtitle = element_text(colour = "gray50", face = "bold", size = 22, lineheight = .5, hjust = .5, vjust = .5),
                 axis.text = element_text(size = 20),
                 strip.text = element_text(size = 20), 
                 axis.title.x = element_text(color = "gray40", size = 20), 
                 panel.grid.major.x = element_blank(),
                 panel.grid.minor.x = element_blank(),
                 panel.grid.major.y = element_line(colour = "grey70", linetype = "dotted"),
                 text = element_text(family = "foo"))
```

# Background

Ever since San Antonio confirmed its first COVID-19 case more than one year ago, the COVID-19 pandemic and the associated social and economic fallout have upended the lives of many locally. The significant social and economic disruptions have caused tremendous stress for virtually everyone in our communities. The pandemic has challenged people's everyday routines on an unprecedented scale. Joblessness remains high and many report that their households lack sufficient food to eat or are not able to make rental, medical, utility bill payments. These significant stressors following COVID-19 could exert negative impacts on people's physical and mental health. The potential economic hardship and health consequences following the pandemic are likely to be unequally distributed and shaped by different ecological structure of local neighborhood conditions. In this policy brief, we compare and contrast two neighborhoods with drastic differences in racial and ethnic composition and socioeconomic status. [maybe add a sentence or two about families with dependent, childcare, etc]

# Data collection and Methods

-questionnaire design

The **San Antonio Energy and Time Use Survey** is an online survey that was answered between March 22-24 by residents of zip codes 78230 (referred to as Elm Creek) and 78202 (referred to as Jefferson Heights). The household level questionnaire collects information on time use, energy consumption, health status and medical devices, employment situation and demographic characteristics.  Upon completion of the survey, respondents received a \$10 Target e-gift card as a compensation for their time. We specifically chose two study sites that are different from each other in terms of racial and ethnic composition and socioeconomic conditions. The study was approved by UTSA IRB. 

**Elm Creek** neighborhood, contained within the city limits of San Antonio, TX, Shavano Park, TX, and Castle Hills, TX. The income per capita of \$38,640 is 1.3 times the income per capita for the San Antonio-New Braunfels Metro Area ($29,071). 93.6% of the population within the zip code has at least gained their high school diploma while only 6% of the population has not gained any sort of degree. 48% of the population is of Hispanic heritage, followed by 39% of the population identifying as White. The minority population in Elm Creek is Asian, with only 5% identifying as Asian. Regarding poverty, **12.5% of people are below the poverty line** with children (under 18) at a 17% below the poverty line and seniors (65 and over) are at a 7%.

Whereas **Jefferson Heights** â€” a disadvantaged neighborhood located in the east side of San Antonio, TX, income per capita of \$18,710 is almost two-thirds of the per capita income of San Antonio-New Braunfels Metro Area. 68.1% of the population in Jefferson Heights has at least gained their high school diploma while 32% of the population has not gained any sort of degree. 60% of the population is of Hispanic heritage, followed by 27% of the population identifying as Black. Aside from a 2% identifying as two or more races, the minority population in this zip code is White, with only 11% identifying as White. Regarding poverty, **37.8% of people are below the poverty line**, making it more than double of the average 14.4% rate in the San Antonio-New Braunfels Metro Area with children (under 18) at a 58% poverty and seniors (65 and over) are at 21% poverty.

We launched our online survey on March 22, 2021 on [platform]. From March 22 to March 24, we collected 1022 survey respondents, of which 805 were valid responses with complete information on key demographic and socioeconomic information. We excluded 63 respondents from other zip codes and 154 respondents for  due to lack of information, and inconsistencies with their response time and the number of valid responses. The final analytical sample consists of 805 respondents in total, of which 479 are from Elm Creek and 326 are from Jefferson Heights. 

*Include 1 table & 1 figure to demonstrate the differences between two neighborhoods*

```{r loss_income, include=FALSE, message=FALSE}
loss <- data %>%
  filter(hardships_1 == 1) %>% 
  group_by(zipcode, race_eth2) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1)) 

data %>%
  filter(hardships_1 == 1) %>% 
  group_by(zipcode) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1)) 
```

```{r plot_loss_income}
loss %>% 
  ggplot(aes(x = zipcode, y = pct, fill = race_eth2)) + 
  geom_bar(stat = "identity", position = "dodge", color = "gray30") +
  geom_text(aes(label = lbl), size = 6.5, color = "gray30", position = position_dodge(width = .9), vjust = -.7, family = "foo") +
  scale_y_continuous(limits = c(0, .60), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_fill_jama() +
  labs(y = NULL, x = NULL, fill = NULL,
       title = str_wrap("Figure 1. Loss of employment by race and ethnicity", width = 75), 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeu

loss %>% 
  ggplot(aes(x = pct, y = reorder(race_eth2, pct), color = zipcode)) +
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(limits = c(0, .5), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Figure 1. Loss of employment by race and ethnicity", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

loss %>% 
  ggplot(aes(x = pct, y = reorder(race_eth2, pct), color = zipcode)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(limits = c(0, .5), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)),
         size = FALSE) +
  labs(y = NULL, x = NULL, color = NULL, size = NULL,
       title = "Figure 1. Loss of employment by race and ethnicity", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf
```

## Loss of employment and health

The impacts of the pandemic are particularly prevalent among African American, Latinx, indigenous, and immigrant households. One representation of long-standing inequalities and an orderly system that reinforces the inequality gap between the different groups.

In many cases, job loss also represents loss of main income for the household, specially in households with dependents. In such cases, paying for the necessary food, the utility bills or rent/mortgage, can turn dramatically into more hardships to deal with during this pandemic.

An adequate state of health would be difficult to achieve under these conditions. In Figure 2 we show the self-reported health status among those respondents who lost their jobs.

```{r days_health, include=FALSE, message=FALSE}
lossxhealth <- data %>%
  filter(hardships_1 == 1) %>% 
  group_by(zipcode, health) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1))  

lossxhealth2 <- data %>%
  filter(hardships_1 == 1) %>% 
  group_by(zipcode, race_eth2, depen) %>%
  summarize(ph.mean = round(mean(physical_health), 1),
            mh.mean = round(mean(mental_health), 1),
            n = n()) 
```

```{r plot_days_health}
lossxhealth %>% 
  ggplot(aes(x = zipcode, y = pct, fill = health)) + 
  geom_bar(stat = "identity", position = "dodge", color = "gray30") +
  geom_text(aes(label = lbl), size = 7, color = "gray30", position = position_dodge(width = .9), vjust = -.7, family = "foo") +
  scale_y_continuous(limits = c(0, .60), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_fill_manual(values = wes_palette(name = "Zissou1", n = 5)) +
  labs(y = NULL, 
       fill = NULL,
       x = NULL, 
       title = str_wrap("Figure 2. Self-rated health status distribution among those who lost their job", width = 60), 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeu

lossxhealth %>% 
  ggplot(aes(color = zipcode, x = pct, y = health)) + 
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(limits = c(0, .5), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_y_discrete(limits = rev(levels(data$health))) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = str_wrap("Figure 2. Self-rated health status distribution among those who lost their job", width = 60), 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

lossxhealth %>% 
  ggplot(aes(color = zipcode, x = pct, y = health)) + 
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(limits = c(0, .5), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_y_discrete(limits = rev(levels(data$health))) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)),
         size = FALSE) +
  labs(y = NULL, x = NULL, color = NULL,
       title = str_wrap("Figure 2. Self-rated health status distribution among those who lost their job", width = 60), 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf
```

## Loss of employment and health II

We present the average number of days with not good physical health and mental health among those who lost their job. 

```{r plot_days_health_ii}
lossxhealth2 %>% 
  mutate(label = ph.mean) %>% 
  ggplot(aes(x = ph.mean, y = reorder(race_eth2, ph.mean))) + 
  geom_line(color = "gray70", size = 1) +
  geom_point(aes(color = depen, size = n), shape = 19) +
  facet_grid(~zipcode) +
  geom_text_repel(aes(label = label, x = ph.mean), size = 6, color = "gray30", nudge_y = .31, segment.alpha = 0, family = "foo") +
  scale_color_igv(palette = "alternating") +
  scale_x_continuous(limits = c(0, 5), breaks = seq(0, 5, 1)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)),
         size = FALSE) +
  labs(y = NULL, 
       color = "Do you have any dependents?",
       x = "Number of days",
       title = str_wrap("For how many days during the past 30 days was your physical health not good?", width = 50), 
       subtitle = str_wrap("We show the average number of days without good physical health by race and ethnicity", width = 65),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() + 
  themeuf 

lossxhealth2 %>% 
  mutate(label = mh.mean) %>% 
  ggplot(aes(x = mh.mean, y = reorder(race_eth2, mh.mean))) + 
  geom_line(color = "gray70", size = 1) +
  geom_point(aes(color = depen, size = n), shape = 19) +
  facet_grid(~zipcode) +
  geom_text_repel(aes(label = label, x = mh.mean), size = 6, color = "gray30", nudge_y = .31, segment.alpha = 0, family = "foo") +
  scale_color_igv(palette = "alternating") +
  scale_x_continuous(limits = c(0, 12), breaks = seq(0, 12, 2)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)),
         size = FALSE) +
  labs(y = NULL,  
       x = "Number of days", 
       color = "Do you have any dependents?",
       title = str_wrap("For how many days during the past 30 days was your mental health not good?", width = 50), 
       subtitle = str_wrap("We show the average number of days without good mental health by race and ethnicity", width = 65),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf
```

## Loss of employment and health III

We present the average number of days with not good physical health and mental health among those who lost their job and experienced two more hardships like difficulty in paying utility bills, in affording the kinds of food you need, in paying next rent or mortgage payment, in paying medical bill/health insurance, add delay getting/Do not get medical care or prescription medication. 

```{r, message=FALSE}
lossxbad2 <- data %>% 
  filter(bad == "More than two", hardships_1 == 1) %>% 
  group_by(zipcode, race_eth2, depen) %>%
  summarize(ph.mean = round(mean(physical_health), 1),
            mh.mean = round(mean(mental_health), 1),
            n = n()) 

lossxbad2 %>% 
  mutate(label = ph.mean) %>% 
  ggplot(aes(x = ph.mean, y = reorder(race_eth2, ph.mean))) + 
  geom_line(color = "gray70", size = 1) +
  geom_point(aes(color = depen, size = n), shape = 19) +
  facet_grid(~zipcode) +
  geom_text(aes(label = label, x = ph.mean), size = 6, color = "gray30", nudge_y = .3) +
  scale_color_igv(palette = "alternating") +
  scale_x_continuous(limits = c(0, 7), breaks = seq(0, 7, 1)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)),
         size = FALSE) +
  labs(y = NULL, x = "Number of days", 
       color = "Do you have any dependents?",
       title = str_wrap("For how many days during the past 30 days was your physical health not good?", width = 50), 
       subtitle = str_wrap("We show the average number of days without good physical health by race and ethnicity among those with more than two hardships",
                           width = 65),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

lossxbad2 %>% 
  mutate(label = mh.mean) %>% 
  ggplot(aes(x = mh.mean, y = reorder(race_eth2, mh.mean))) + 
  geom_line(color = "gray70", size = 1) +
  geom_point(aes(color = depen, size = n), shape = 19) +
  facet_grid(~zipcode) +
  geom_text_repel(aes(label = label, x = mh.mean), size = 6, color = "gray30", nudge_y = .3, segment.alpha = 0) +
  scale_color_igv(palette = "alternating") +
  scale_x_continuous(limits = c(0, 15), breaks = seq(0, 15, 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)),
         size = FALSE) +
  labs(y = NULL, x = "Number of days", 
       color = "Do you have any dependents?",
       title = str_wrap("For how many days during the past 30 days was your mental health not good?", width = 50), 
       subtitle = str_wrap("We show the average number of days without good mental health by race and ethnicity among those with more than two hardships",
                           width = 65),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf
```

```{r, include=FALSE}
h1 <- data %>% 
  select(zipcode, hardships_1:hardships_6, age:bad) %>% 
  filter(bad == "One hardship") 

h2 <- data %>% 
  select(zipcode, hardships_1:hardships_6, age:bad) %>% 
  filter(bad == "Two hardships") 

h3 <- data %>% 
  select(zipcode, hardships_1:hardships_6, age:bad) %>% 
  filter(bad == "More than two") 
####################
h11 <- h1 %>% 
  group_by(zipcode) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))
h12 <- h1 %>% 
  group_by(zipcode, gender2) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))

h21 <- h2 %>% 
  group_by(zipcode) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))
h22 <- h2 %>% 
  group_by(zipcode, gender2) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))

h31 <- h3 %>% 
  group_by(zipcode) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))
h32 <- h3 %>% 
  group_by(zipcode, gender2) %>% 
  summarise_at(vars(hardships_1:hardships_6), funs(round(mean(., na.rm = T), 3)))
####################
h11 <- h11 %>%  
  tidyr::pivot_longer(cols = 2:7, names_to = "hard", values_to = "mean")
h12 <- h12 %>%  
  tidyr::pivot_longer(cols = 3:8, names_to = "hard", values_to = "mean")

h21 <- h21 %>%  
  tidyr::pivot_longer(cols = 2:7, names_to = "hard", values_to = "mean")
h22 <- h22 %>%  
  tidyr::pivot_longer(cols = 3:8, names_to = "hard", values_to = "mean")

h31 <- h31 %>%  
  tidyr::pivot_longer(cols = 2:7, names_to = "hard", values_to = "mean")
h32 <- h32 %>%  
  tidyr::pivot_longer(cols = 3:8, names_to = "hard", values_to = "mean")
####################
h11 <- h11 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))
h12 <- h12 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))

h21 <- h21 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))
h22 <- h22 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))

h31 <- h31 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))
h32 <- h32 %>% 
  mutate(hard = case_when(hard %in% "hardships_1" ~ "Loss of employment",
                          hard %in% "hardships_2" ~ "Paying utility bills",
                          hard %in% "hardships_3" ~ "Affording food",
                          hard %in% "hardships_4" ~ "Paying next rent",
                          hard %in% "hardships_5" ~ "Paying medical bill",
                          hard %in% "hardships_6" ~ "Delay getting medical"))
####################
h11$hard <- ordered(h11$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))
h12$hard <- ordered(h12$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))

h21$hard <- ordered(h21$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))
h22$hard <- ordered(h22$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))

h31$hard <- ordered(h31$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))
h32$hard <- ordered(h32$hard, levels = c("Loss of employment", "Paying utility bills", "Affording food", 
                                         "Paying next rent", "Paying medical bill", "Delay getting medical"))
```

## 0
```{r emp_status, include=FALSE, message=FALSE, warning=FALSE}
### Task Two: Employment Status
data <- data %>%
  mutate_at(vars(emp_status), ~if_else(. %in% c("Work for pay at a job","Temporarily absent from job"), "employed",
                                    if_else(. %in% c("Layoff from a job","Actively looking for a job"), "unemployed",
                                            if_else(. %in% c("Retired", "Unable to work"), "retired", "NA"))))
############### Employed
employed <- NULL
total <- NULL
employed_pct <- NULL

total <- data %>%
  filter(emp_status != "NA") %>%
  group_by(zipcode, race_eth2) %>%
  summarize(n = n())

employed <- data %>%
  filter(emp_status == "employed") %>%
  group_by(zipcode, race_eth2) %>%
  summarize(employed_n = n())

employed_pct <- data.frame(total[,"zipcode"],total[,"race_eth2"],total[,"n"],employed[,"employed_n"])

employed_pct <- employed_pct %>%
        mutate(pct = employed_n/n,
               lbl = scales::percent(pct, accuracy = 0.1))

employed_pct$zipcode <- as.factor(employed_pct$zipcode)

################ Unemployed
unemployed <- NULL
asian <- NULL
zipcode <- "Jefferson Heights"
race_eth2 <- "Non-Hispanic Asian"
unemployed_n <- 0
asian <- data.frame(zipcode,race_eth2,unemployed_n)
colnames(asian) <- c("zipcode","race_eth2","unemployed_n")
unemployed <- data %>%
  filter(emp_status == "unemployed") %>%
  group_by(zipcode, race_eth2) %>%
  summarize(unemployed_n = n())
unemployed <- data.frame(unemployed)
colnames(unemployed) <- c("zipcode","race_eth2","unemployed_n")
unemployed <- rbind(unemployed,asian)
unemployed <- unemployed[with(unemployed,order(zipcode,race_eth2)),] 
unemployed_pct <- data.frame(total[,"zipcode"],total[,"race_eth2"],total[,"n"],unemployed[,"unemployed_n"])
colnames(unemployed_pct) <- c("zipcode","race_eth2","n","unemployed_n")
unemployed_pct$unemployed_n <- as.numeric(unemployed_pct$unemployed_n)
unemployed_pct <- unemployed_pct %>%
        mutate(pct = unemployed_n/n,
               lbl = scales::percent(pct, accuracy = 0.1))

############ Retired
retired <- NULL
retired <- data %>%
  filter(emp_status == "retired") %>%
  group_by(zipcode, race_eth2) %>%
  summarize(retired_n = n())
retired <- data.frame(retired)
colnames(retired) <- c("zipcode","race_eth2","retired_n")
zipcode <- c("Elm Creek","Elm Creek","Jefferson Heights","Jefferson Heights")
race_eth2 <- c("Non-Hispanic Asian","Non-Hispanic Black","Non-Hispanic Asian","Non-Hispanic Other")
retired_n <- c(0,0,0,0)
retired_zero <- data.frame(zipcode,race_eth2,retired_n)
colnames(retired_zero) <- c("zipcode","race_eth2","retired_n")
retired <- rbind(retired,retired_zero)
retired <- retired[with(retired,order(zipcode,race_eth2)),]
retired_pct <- data.frame(total[,"zipcode"],total[,"race_eth2"],total[,"n"],retired[,"retired_n"])
colnames(retired_pct) <- c("zipcode","race_eth2","n","retired_n")
retired_pct$retired_n <- as.numeric(retired$retired_n)
retired_pct <- retired_pct %>%
        mutate(pct = retired_n/n,
               lbl = scales::percent(pct, accuracy = 0.1))
```

```{r emp_status_plot, message=FALSE}
employed_pct %>%
  ggplot(aes(x = pct, y = reorder(race_eth2, pct),color = zipcode)) + 
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(limits = c(0, 1), breaks = c(0,0.2,0.4,0.6,0.8,1.0), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Figure 1. Employment Status: Employed by race and ethnicity", 
       subtitle = str_wrap("In the last seven days, what is your employment status?"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

unemployed_pct %>%
  ggplot(aes(x = pct, y = reorder(race_eth2, pct),color = zipcode)) + 
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Figure 2. Employment Status: Unemployed by race and ethnicity", 
       subtitle = str_wrap("In the last seven days, what is your employment status?"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

retired_pct %>%
  ggplot(aes(x = pct, y = reorder(race_eth2, pct),color = zipcode)) + 
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Figure 3. Employment Status: Retired by race and ethnicity", 
       subtitle = str_wrap("In the last seven days, what is your employment status?"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf
```

```{r other_ses, message=FALSE, warning=FALSE}
### Task Three: Other SES
### frontline worker
frontline <- NULL
total <- NULL
frontline_pct <- NULL
total <- data %>%
  group_by(zipcode, race_eth2) %>%
  summarize(n = n(),na.rm = TRUE)
frontline <- data %>%
  filter(frontline == "Yes") %>%
  group_by(zipcode, race_eth2) %>%
  summarize(frontline_n = n())
frontline_pct <- data.frame(total[,"zipcode"],total[,"race_eth2"],total[,"n"],frontline[,"frontline_n"])
frontline_pct <- frontline_pct %>%
  mutate(pct = frontline_n/n,
               lbl = scales::percent(pct, accuracy = 0.1))
frontline_pct %>%
  ggplot(aes(x = pct, y = reorder(race_eth2, pct),color = zipcode)) + 
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Figure 1. Frontline worker by race and ethnicity", 
       subtitle = str_wrap("Are you a frontline worker?"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

### average hrs_work
hrs_work <- data %>%
  filter(hrs_work_3 != "NA") %>%
  group_by(zipcode, race_eth2) %>%
  summarize(average_hrs = mean(hrs_work_3))
hrs_work %>%
  ggplot(aes(x = average_hrs, y = reorder(race_eth2,average_hrs ),color = zipcode)) + 
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = round(average_hrs,2)), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(limits = c(30,45)) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Figure 2. Average Working Hours by race and ethnicity", 
       subtitle = str_wrap("How many hours per week do you usually work?"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

### welfare_1
asian <- NULL
total_1 <- data[!is.na(data$welfare_1),]
total_1 <- total_1 %>%
  group_by(zipcode, race_eth2) %>%
  summarize(n = n())
zipcode <- "Jefferson Heights"
race_eth2 <- "Non-Hispanic Asian"
welfare_1 <- 0
asian <- data.frame(zipcode,race_eth2,welfare_1)
welfare_1 <- data %>%
  filter(welfare_1 == "Yes") %>%
  group_by(zipcode, race_eth2) %>%
  summarize(welfare_1 = n())
welfare_1 <- data.frame(welfare_1)
welfare_1 <- rbind(welfare_1,asian)
welfare_1 <- welfare_1[with(welfare_1,order(zipcode,race_eth2)),] 
welfare_1_pct <- data.frame(total_1[,"zipcode"],total_1[,"race_eth2"],total_1[,"n"],welfare_1[,"welfare_1"])
colnames(welfare_1_pct) <- c("zipcode","race_eth2","n","welfare_1")
welfare_1_pct <- welfare_1_pct %>%
  mutate(pct = welfare_1/n,
         lbl = scales::percent(pct, accuracy = 0.1))
welfare_1_pct %>%
  ggplot(aes(x = pct, y = reorder(race_eth2,pct),color = zipcode)) + 
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Figure 4. % of Welfare_1 (Unemployment Insurance) by race and ethnicity", 
       subtitle = str_wrap("Have you, or has anyone in your household received any of the following:"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

### welfare_2
total_2 <- NULL
total_2 <- data[!is.na(data$welfare_2),]
total_2 <- total_2 %>%
  group_by(zipcode, race_eth2) %>%
  summarize(n = n())
welfare_2 <- data %>%
  filter(welfare_2 == "Yes") %>%
  group_by(zipcode, race_eth2) %>%
  summarize(welfare_2 = n())
welfare_2_pct <- data.frame(total_1[,"zipcode"],total_1[,"race_eth2"],total_1[,"n"],welfare_2[,"welfare_2"])
welfare_2_pct <- welfare_2_pct %>%
  mutate(pct = welfare_2/n,
         lbl = scales::percent(pct, accuracy = 0.1))
welfare_2_pct %>%
  ggplot(aes(x = pct, y = reorder(race_eth2,pct),color = zipcode)) + 
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Figure 5. % of Welfare_2 (Social Security benefits) by race and ethnicity", 
       subtitle = str_wrap("Have you, or has anyone in your household received any of the following:"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf


### welfare_3
total_3 <- NULL
total_3 <- data[!is.na(data$welfare_3),]
total_3 <- total_3 %>%
  group_by(zipcode, race_eth2) %>%
  summarize(n = n())
zipcode <- c("Elm Creek","Jefferson Heights")
race_eth2 <- c("Non-Hispanic Asian","Non-Hispanic Other")
welfare_3 <- c(0,0)
zero <- data.frame(zipcode, race_eth2, welfare_3)
welfare_3 <- data %>%
  filter(welfare_3 == "Yes") %>%
  group_by(zipcode, race_eth2) %>%
  summarize(welfare_3 = n())
welfare_3 <- data.frame(welfare_3)
welfare_3 <- rbind(welfare_3,zero)
welfare_3 <- welfare_3[with(welfare_3,order(zipcode,race_eth2)),]
welfare_3_pct <- data.frame(total_3[,"zipcode"],total_3[,"race_eth2"],total_3[,"n"],welfare_3[,"welfare_3"])
colnames(welfare_3_pct) <- c("zipcode","race_eth2","n","welfare_3")
welfare_3_pct <- welfare_3_pct %>%
  mutate(pct = welfare_3/n,
         lbl = scales::percent(pct, accuracy = 0.1))
welfare_3_pct %>%
  ggplot(aes(x = pct, y = reorder(race_eth2,pct),color = zipcode)) + 
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Figure 6. % of Welfare_3 (Supplemental Security Income (SSI)) by race and ethnicity", 
       subtitle = str_wrap("Have you, or has anyone in your household received any of the following:"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

### welfare_4
total_4 <- NULL
total_4 <- data[!is.na(data$welfare_4),]
total_4 <- total_4 %>%
  group_by(zipcode, race_eth2) %>%
  summarize(n = n())
zipcode <- "Jefferson Heights"
race_eth2 <- "Non-Hispanic Asian"
welfare_4 <- 0
zero <- data.frame(zipcode, race_eth2, welfare_4)
welfare_4 <- data %>%
  filter(welfare_4 == "Yes") %>%
  group_by(zipcode, race_eth2) %>%
  summarize(welfare_4 = n())
welfare_4 <- data.frame(welfare_4)
welfare_4 <- rbind(welfare_4,zero)
welfare_4 <- welfare_4[with(welfare_4,order(zipcode,race_eth2)),]
welfare_4_pct <- data.frame(total_4[,"zipcode"],total_4[,"race_eth2"],total_4[,"n"],welfare_4[,"welfare_4"])
colnames(welfare_4_pct) <- c("zipcode","race_eth2","n","welfare_4")
welfare_4_pct <- welfare_4_pct %>%
  mutate(pct = welfare_4/n,
         lbl = scales::percent(pct, accuracy = 0.1))
welfare_4_pct %>%
  ggplot(aes(x = pct, y = reorder(race_eth2,pct),color = zipcode)) + 
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Figure 7. % of Welfare_4 Medicare benefits by race and ethnicity", 
       subtitle = str_wrap("Have you, or has anyone in your household received any of the following:"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

### welfare_5
total_5 <- NULL
total_5 <- data[!is.na(data$welfare_5),]
total_5 <- total_5 %>%
  group_by(zipcode, race_eth2) %>%
  summarize(n = n())
zipcode <- "Jefferson Heights"
race_eth2 <- "Non-Hispanic Asian"
welfare_5 <- 0
zero <- data.frame(zipcode, race_eth2, welfare_5)
welfare_5 <- data %>%
  filter(welfare_5 == "Yes") %>%
  group_by(zipcode, race_eth2) %>%
  summarize(welfare_5 = n())
welfare_5 <- data.frame(welfare_5)
welfare_5 <- rbind(welfare_5,zero)
welfare_5 <- welfare_5[with(welfare_5,order(zipcode,race_eth2)),]
welfare_5_pct <- data.frame(total_5[,"zipcode"],total_5[,"race_eth2"],total_5[,"n"],welfare_5[,"welfare_5"])
colnames(welfare_5_pct) <- c("zipcode","race_eth2","n","welfare_5")
welfare_5_pct <- welfare_5_pct %>%
  mutate(pct = welfare_5/n,
         lbl = scales::percent(pct, accuracy = 0.1))
welfare_5_pct %>%
  ggplot(aes(x = pct, y = reorder(race_eth2,pct),color = zipcode)) + 
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Figure 8. % of Welfare_5 Stimulus (economic impact) Payment by race and ethnicity", 
       subtitle = str_wrap("Have you, or has anyone in your household received any of the following:"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

### welfare_6
total_6 <- NULL
total_6 <- data[!is.na(data$welfare_6),]
total_6 <- total_6 %>%
  group_by(zipcode, race_eth2) %>%
  summarize(n = n())
zipcode <- c("Jefferson Heights","Elm Creek")
race_eth2 <- c("Non-Hispanic Asian","Non-Hispanic Asian")
welfare_6 <- c(0,0)
zero <- data.frame(zipcode, race_eth2, welfare_6)
welfare_6 <- data %>%
  filter(welfare_6 == "Yes") %>%
  group_by(zipcode, race_eth2) %>%
  summarize(welfare_6 = n())
welfare_6 <- data.frame(welfare_6)
welfare_6 <- rbind(welfare_6,zero)
welfare_6 <- welfare_6[with(welfare_6,order(zipcode,race_eth2)),]
welfare_6_pct <- data.frame(total_6[,"zipcode"],total_6[,"race_eth2"],total_6[,"n"],welfare_6[,"welfare_6"])
colnames(welfare_6_pct) <- c("zipcode","race_eth2","n","welfare_6")
welfare_6_pct <- welfare_6_pct %>%
  mutate(pct = welfare_6/n,
         lbl = scales::percent(pct, accuracy = 0.1))
welfare_6_pct %>%
  ggplot(aes(x = pct, y = reorder(race_eth2,pct),color = zipcode)) + 
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Figure 9. % of Welfare_6 Supplemental Nutrition Assistance Program (SNAP) by race and ethnicity", 
       subtitle = str_wrap("Have you, or has anyone in your household received any of the following:"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

### welfare_7
total_7 <- NULL
total_7 <- data[!is.na(data$welfare_7),]
total_7 <- total_7 %>%
  group_by(zipcode, race_eth2) %>%
  summarize(n = n())
welfare_7 <- data %>%
  filter(welfare_7 == "Yes") %>%
  group_by(zipcode, race_eth2) %>%
  summarize(welfare_7 = n())
welfare_7_pct <- data.frame(total_7[,"zipcode"],total_7[,"race_eth2"],total_7[,"n"],welfare_7[,"welfare_7"])
colnames(welfare_7_pct) <- c("zipcode","race_eth2","n","welfare_7")
welfare_7_pct <- welfare_7_pct %>%
  mutate(pct = welfare_7/n,
         lbl = scales::percent(pct, accuracy = 0.1))
welfare_7_pct %>%
  ggplot(aes(x = pct, y = reorder(race_eth2,pct),color = zipcode)) + 
  geom_point(stat = "identity", size = 5) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .3, nudge_x = .01) +
  scale_x_continuous(label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1)) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Figure 10. % of Welfare_7 Other types of need-based assistance from the city or federal government by race and ethnicity", 
       subtitle = str_wrap("Have you, or has anyone in your household received any of the following:"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf
```

## 1
```{r, include=FALSE, message=FALSE}
loss.1 <- data %>% 
  filter(!is.na(hardships_1)) %>% 
  rename(hardships = hardships_1) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Job loss", 
                               if_else(hardships == 0, "No difficulty", "NA"))) 

loss.2 <- data %>% 
  filter(!is.na(hardships_2)) %>% 
  rename(hardships = hardships_2) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Paying utility bills", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.3 <- data %>% 
  filter(!is.na(hardships_3)) %>% 
  rename(hardships = hardships_3) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Affording foods", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.4 <- data %>% 
  filter(!is.na(hardships_4)) %>% 
  rename(hardships = hardships_4) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Paying rent/mortgage", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.5 <- data %>% 
  filter(!is.na(hardships_5)) %>% 
  rename(hardships = hardships_5) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Paying medical bills", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.6 <- data %>% 
  filter(!is.na(hardships_6)) %>% 
  rename(hardships = hardships_6) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Delay getting medical care", 
                               if_else(hardships == 0, "No difficulty", "NA")))  


hardships <- rbind(loss.1, loss.2, loss.3, loss.4, loss.5, loss.6)
```

```{r plots_1, message=FALSE}
loss.1 %>% 
  ggplot(aes(x = pct, y = reorder(hardships, pct), color = zipcode)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6.5, color = "gray30", segment.alpha = 0, family = "foo", nudge_x = .03, nudge_y = .2) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Loss of employment by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

loss.2 %>% 
  ggplot(aes(x = pct, y = reorder(hardships, pct), color = zipcode)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6.5, color = "gray30", segment.alpha = 0, family = "foo", nudge_x = .03, nudge_y = .2) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Difficulty in paying utility bills by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced difficulties their paying utility bills"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

loss.3 %>% 
  ggplot(aes(x = pct, y = reorder(hardships, pct), color = zipcode)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6.5, color = "gray30", segment.alpha = 0, family = "foo", nudge_x = .03, nudge_y = .2) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Difficulty in affording the food you need by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced difficulties affording the food you need"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

loss.4 %>% 
  ggplot(aes(x = pct, y = reorder(hardships, pct), color = zipcode)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6.5, color = "gray30", segment.alpha = 0, family = "foo", nudge_x = .03, nudge_y = .2) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Difficulty in paying rent or mortgage by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced difficulties paying rent or mortgage"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

loss.5 %>% 
  ggplot(aes(x = pct, y = reorder(hardships, pct), color = zipcode)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6.5, color = "gray30", segment.alpha = 0, family = "foo", nudge_x = .03, nudge_y = .2) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Difficulty in paying medical bill/health insurance by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced difficulties paying medical bills"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

loss.6 %>% 
  ggplot(aes(x = pct, y = reorder(hardships, pct), color = zipcode)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6.5, color = "gray30", segment.alpha = 0, family = "foo", nudge_x = .03, nudge_y = .2) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Delay getting medical care or medication by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced delay getting medical care or prescription medication"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

hardships %>% 
  filter(hardships != "No difficulty") %>% 
  ggplot(aes(x = pct, y = reorder(hardships, pct), color = zipcode)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .2, nudge_x = .03) +
  scale_x_continuous(limits = c(0, .75), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Type of hardship experienced by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), have you, or has anyone in your household experienced any of the following hardships"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

data %>%
  filter(!is.na(bad)) %>% 
  group_by(zipcode, bad) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1)) %>% 
  ggplot(aes(x = pct, y = reorder(bad, pct), color = zipcode)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6.5, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .2, nudge_x = .03) +
  scale_x_continuous(limits = c(0, .7), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Number of hardships by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), have you, or has anyone in your household experienced any type of hardships"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf
```

## 2
```{r, include=FALSE, message=FALSE}
loss.1r <- data %>% 
  filter(!is.na(hardships_1)) %>% 
  rename(hardships = hardships_1) %>% 
  group_by(zipcode, hardships, race_eth2) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Job loss", 
                               if_else(hardships == 0, "No difficulty", "NA"))) 

loss.2r <- data %>% 
  filter(!is.na(hardships_2)) %>% 
  rename(hardships = hardships_2) %>% 
  group_by(zipcode, hardships, race_eth2) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Paying utility bills", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.3r <- data %>% 
  filter(!is.na(hardships_3)) %>% 
  rename(hardships = hardships_3) %>% 
  group_by(zipcode, hardships, race_eth2) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Affording food", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.4r <- data %>% 
  filter(!is.na(hardships_4)) %>% 
  rename(hardships = hardships_4) %>% 
  group_by(zipcode, hardships, race_eth2) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Paying rent/mortgage", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.5r <- data %>% 
  filter(!is.na(hardships_5)) %>% 
  rename(hardships = hardships_5) %>% 
  group_by(zipcode, hardships, race_eth2) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Paying medical bills", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

loss.6r <- data %>% 
  filter(!is.na(hardships_6)) %>% 
  rename(hardships = hardships_6) %>% 
  group_by(zipcode, hardships, race_eth2) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Delay getting medical care", 
                               if_else(hardships == 0, "No difficulty", "NA")))  


hardships.r <- rbind(loss.1r, loss.2r, loss.3r, loss.4r, loss.5r, loss.6r)

loss.1r$hardships <- ordered(loss.1r$hardships, levels = c("No difficulty", "Job loss"))
loss.2r$hardships <- ordered(loss.2r$hardships, levels = c("No difficulty", "Paying utility bills"))
loss.3r$hardships <- ordered(loss.3r$hardships, levels = c("No difficulty", "Affording food"))
loss.4r$hardships <- ordered(loss.4r$hardships, levels = c("No difficulty", "Paying rent/mortgage"))
loss.5r$hardships <- ordered(loss.5r$hardships, levels = c("No difficulty", "Paying medical bills"))
loss.6r$hardships <- ordered(loss.6r$hardships, levels = c("No difficulty", "Delay getting medical care"))
```

```{r plots_2, message=FALSE, warning=FALSE}
loss.1r %>% 
  ggplot(aes(x = pct, y = reorder(race_eth2, pct), color = hardships)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .2, nudge_x = .03) +
  scale_x_continuous(limits = c(0, .60), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 5)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5), reverse = T),
         size = F) +
  facet_grid(~zipcode) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Loss of employment by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

loss.2r %>% 
  ggplot(aes(x = pct, y = reorder(race_eth2, pct), color = hardships)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .2, nudge_x = .03) +
  scale_x_continuous(limits = c(0, .60), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 5)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5), reverse = T),
         size = F) +
  facet_grid(~zipcode) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Difficulty in paying utility bills by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced difficulties their paying utility bills"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

loss.3r %>% 
  ggplot(aes(x = pct, y = reorder(race_eth2, pct), color = hardships)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .2, nudge_x = .03) +
  scale_x_continuous(limits = c(0, .60), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 5)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5), reverse = T),
         size = F) +
  facet_grid(~zipcode) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Difficulty in affording the food you need by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced difficulties affording the food you need"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

loss.4r %>% 
  ggplot(aes(x = pct, y = reorder(race_eth2, pct), color = hardships)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .2, nudge_x = .03) +
  scale_x_continuous(limits = c(0, .60), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 5)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5), reverse = T),
         size = F) +
  facet_grid(~zipcode) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Difficulty in paying rent or mortgage by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced difficulties paying rent or mortgage"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

loss.5r %>% 
  ggplot(aes(x = pct, y = reorder(race_eth2, pct), color = hardships)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .2, nudge_x = .03) +
  scale_x_continuous(limits = c(0, .60), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 5)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5), reverse = T),
         size = F) +
  facet_grid(~zipcode) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Difficulty in paying medical bill/health insurance by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced difficulties paying medical bills"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

loss.6r %>% 
  ggplot(aes(x = pct, y = reorder(race_eth2, pct), color = hardships)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 6, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .2, nudge_x = .03) +
  scale_x_continuous(limits = c(0, .60), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 5)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5), reverse = T),
         size = F) +
  facet_grid(~zipcode) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Delay getting medical care or medication by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced delay getting medical care or prescription medication"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

hardships.r %>% 
  filter(hardships != "No difficulty") %>% 
  ggplot(aes(x = pct, y = reorder(hardships, -pct), color = race_eth2)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 4.5, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .25, nudge_x = .025) +
  scale_x_continuous(limits = c(0, .65), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Zissou1", n = 5)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 4), reverse = F, byrow = T, ncol = 3), 
         size = F) +
  facet_grid(~zipcode) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Type of hardship experienced by race and ethnicity", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), have you, or has anyone in your household experienced any of the following hardships"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf + theme(legend.position = "bottom")

data %>%
  filter(!is.na(bad)) %>% 
  group_by(zipcode, race_eth2, bad) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1)) %>% 
  ggplot(aes(x = pct, y = reorder(race_eth2, -pct), color = zipcode)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 5, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .2, nudge_x = .01) +
  scale_x_continuous(limits = c(0, .75), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  facet_grid(~bad) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Number of hardships by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), have you, or has anyone in your household experienced any type of hardships"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf + theme(axis.text.x = element_text(color = "gray40", size = 18))
```

## 3
```{r plots_3, message=FALSE, warning=FALSE}
data %>%
  group_by(zipcode, health) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1)) %>% 
  ggplot(aes(x = pct, y = health, color = zipcode)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 5.5, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .2, nudge_x = .02) +
  scale_x_continuous(limits = c(0, .5), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_y_discrete(limits = rev(levels(data$health))) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Self-rated health status by race and ethnicity", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

data %>%
  group_by(zipcode, race_eth2, health) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1)) %>% 
  ggplot(aes(x = pct, y = race_eth2, color = health)) +
  geom_point(stat = "identity", aes(size = n)) +
  geom_text_repel(aes(label = lbl), size = 4.5, color = "gray30", segment.alpha = 0, family = "foo", nudge_y = .2, nudge_x = .015) +
  scale_x_continuous(limits = c(0, .9), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_y_discrete(limits = rev(levels(data$race_eth2))) +
  scale_color_manual(values = wes_palette("Zissou1", n = 5)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  facet_grid(~zipcode) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Self-rated health status by race and ethnicity", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

data %>% 
  group_by(zipcode) %>%
  summarize(ph.mean = round(mean(physical_health), 1),
            mh.mean = round(mean(mental_health), 1),
            n = n()) %>% 
  mutate(label = ph.mean,
         label2 = mh.mean) %>% 
  ggplot(aes(y = zipcode, color = zipcode, group = zipcode)) + 
  geom_point(aes(x = ph.mean), shape = 19, size = 5, show.legend = T) +
  geom_point(aes(x = mh.mean), shape = 18, size = 5, show.legend = T) +
  geom_text_repel(aes(label = label, x = ph.mean), size = 7, color = "gray30", nudge_y = .2, segment.alpha = 0, family = "foo") +
  geom_text_repel(aes(label = label2, x = mh.mean), size = 7, color = "gray30", nudge_y = .2, segment.alpha = 0, family = "foo") +
  annotate("text", x = 2, y = 1, label = "Physical health", color = "gray40", size = 8, hjust = "right") +
  annotate("text", x = 5, y = 2, label = "Mental health", color = "gray40", size = 8, hjust = "left") +
  annotate("curve", x = 2, xend = 3.05, y = .95, yend = 1, colour = "gray60", 
           arrow=arrow(type = "open", length = unit(3, "mm")), curvature = .25, hjust = "upper") +
  annotate("curve", x = 5, xend = 3.8, y = 2.05, yend = 2, colour = "gray60", 
           arrow=arrow(type = "open", length = unit(3, "mm")), curvature = .25, hjust = "upper") +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  scale_x_continuous(limits = c(1, 6), breaks = seq(0, 6, 1)) +
  scale_y_discrete(limits = rev(levels(data$zipcode))) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5), reverse = T),
         size = FALSE) +
  labs(y = NULL, 
       color = NULL,
       x = "Number of days",
       title = str_wrap("For how many days during the past 30 days was your physical health not good?", width = 50), 
       subtitle = str_wrap("We show the average number of days without good physical health by race and ethnicity", width = 65),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() + 
  themeuf

data %>% 
  group_by(zipcode, race_eth2) %>%
  summarize(ph.mean = round(mean(physical_health), 1),
            mh.mean = round(mean(mental_health), 1),
            n = n()) %>% 
  mutate(label = ph.mean) %>% 
  ggplot(aes(x = ph.mean, y = race_eth2)) + 
  geom_point(aes(color = zipcode, size = n), shape = 19) +
  geom_text_repel(aes(label = label, x = ph.mean), size = 6, color = "gray30", nudge_y = .31, segment.alpha = 0, family = "foo") +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  scale_x_continuous(limits = c(0, 5), breaks = seq(0, 5, 1)) +
  scale_y_discrete(limits = rev(levels(data$race_eth2))) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)),
         size = FALSE) +
  labs(y = NULL, 
       color = NULL,
       x = "Number of days",
       title = str_wrap("For how many days during the past 30 days was your physical health not good?", width = 50), 
       subtitle = str_wrap("We show the average number of days without good physical health by race and ethnicity", width = 65),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() + 
  themeuf

data %>% 
  group_by(zipcode, race_eth2) %>%
  summarize(ph.mean = round(mean(physical_health), 1),
            mh.mean = round(mean(mental_health), 1),
            n = n()) %>% 
  mutate(label = mh.mean) %>% 
  ggplot(aes(x =mh.mean, y = race_eth2)) + 
  geom_point(aes(color = zipcode, size = n), shape = 19) +
  geom_text_repel(aes(label = label, x = mh.mean), size = 6, color = "gray30", nudge_y = .31, segment.alpha = 0, family = "foo") +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  scale_x_continuous(limits = c(0, 7), breaks = seq(0, 5, 1)) +
  scale_y_discrete(limits = rev(levels(data$race_eth2))) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)),
         size = FALSE) +
  labs(y = NULL, 
       color = NULL,
       x = "Number of days",
       title = str_wrap("For how many days during the past 30 days was your mental health not good?", width = 50), 
       subtitle = str_wrap("We show the average number of days without good mental health by race and ethnicity", width = 65),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() + 
  themeuf
```

#######  
```{r, include=FALSE, eval=FALSE}
#install.packages("mosaic")
hp1 <- mosaic::prop.test(hardships_1 ~ zipcode, data = data, na.rm = T, conf.level = .9)
hp2 <- mosaic::prop.test(hardships_2 ~ zipcode, data = data, na.rm = T, conf.level = .9)
hp3 <- mosaic::prop.test(hardships_3 ~ zipcode, data = data, na.rm = T, conf.level = .9)
hp4 <- mosaic::prop.test(hardships_4 ~ zipcode, data = data, na.rm = T, conf.level = .9)
hp5 <- mosaic::prop.test(hardships_5 ~ zipcode, data = data, na.rm = T, conf.level = .9)
hp6 <- mosaic::prop.test(hardships_6 ~ zipcode, data = data, na.rm = T, conf.level = .9)

hp1.dt <- data.frame(prop = 1 - hp1$estimate, ci.l = hp1$conf.int[1], ci.r = hp1$conf.int[2]) 
hp2.dt <- data.frame(prop = 1 - hp2$estimate, ci.l = hp2$conf.int[1], ci.r = hp2$conf.int[2]) 
hp3.dt <- data.frame(prop = 1 - hp3$estimate, ci.l = hp3$conf.int[1], ci.r = hp3$conf.int[2]) 
hp4.dt <- data.frame(prop = 1 - hp4$estimate, ci.l = hp4$conf.int[1], ci.r = hp4$conf.int[2]) 
hp5.dt <- data.frame(prop = 1 - hp5$estimate, ci.l = hp5$conf.int[1], ci.r = hp5$conf.int[2]) 
hp6.dt <- data.frame(prop = 1 - hp6$estimate, ci.l = hp6$conf.int[1], ci.r = hp6$conf.int[2]) 

hp1.dt <- hp1.dt %>% mutate(lower = ci.l + prop, upper = ci.r + prop)
hp2.dt <- hp2.dt %>% mutate(lower = ci.l + prop, upper = ci.r + prop)
hp3.dt <- hp3.dt %>% mutate(lower = ci.l + prop, upper = ci.r + prop)
hp4.dt <- hp4.dt %>% mutate(lower = ci.l + prop, upper = ci.r + prop)
hp5.dt <- hp5.dt %>% mutate(lower = ci.l + prop, upper = ci.r + prop)
hp6.dt <- hp6.dt %>% mutate(lower = ci.l + prop, upper = ci.r + prop)

hshp.1$lower[c(2,4)] <- hp1.dt$lower
hshp.1$upper[c(2,4)] <- hp1.dt$upper
hshp.2$lower[c(2,4)] <- hp2.dt$lower
hshp.2$upper[c(2,4)] <- hp2.dt$upper
hshp.3$lower[c(2,4)] <- hp3.dt$lower
hshp.3$upper[c(2,4)] <- hp3.dt$upper
hshp.4$lower[c(2,4)] <- hp4.dt$lower
hshp.4$upper[c(2,4)] <- hp4.dt$upper
hshp.5$lower[c(2,4)] <- hp5.dt$lower
hshp.5$upper[c(2,4)] <- hp5.dt$upper
hshp.6$lower[c(2,4)] <- hp6.dt$lower
hshp.6$upper[c(2,4)] <- hp6.dt$upper

```

```{r, include=FALSE, message=FALSE, eval=FALSE}
hshp.1 <- data %>% 
  filter(!is.na(hardships_1)) %>% 
  rename(hardships = hardships_1) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Job loss", 
                               if_else(hardships == 0, "No difficulty", "NA"))) 

hshp.2 <- data %>% 
  filter(!is.na(hardships_2)) %>% 
  rename(hardships = hardships_2) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Paying utility bills", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

hshp.3 <- data %>% 
  filter(!is.na(hardships_3)) %>% 
  rename(hardships = hardships_3) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Affording foods", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

hshp.4 <- data %>% 
  filter(!is.na(hardships_4)) %>% 
  rename(hardships = hardships_4) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Paying rent/mortgage", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

hshp.5 <- data %>% 
  filter(!is.na(hardships_5)) %>% 
  rename(hardships = hardships_5) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Paying medical bills", 
                               if_else(hardships == 0, "No difficulty", "NA")))  

hshp.6 <- data %>% 
  filter(!is.na(hardships_6)) %>% 
  rename(hardships = hardships_6) %>% 
  group_by(zipcode, hardships) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct, accuracy = 0.1),
         hardships = if_else(hardships == 1, "Delay getting medical care", 
                               if_else(hardships == 0, "No difficulty", "NA")))  


hshp.dt <- rbind(hshp.1, hshp.2, hshp.3, hshp.4, hshp.5, hshp.6)
```

```{r, include=FALSE, message=FALSE, eval=FALSE}
hshp.1 %>%
  ggplot(aes(x = pct, y = reorder(hardships, pct), color = zipcode)) +
  geom_linerange(aes(xmin = lower, xmax = upper), size = 1, position = position_dodge(width=0.5)) +
  geom_point(aes(size = n), position = position_dodge(width = 0.5)) +
  geom_text_repel(aes(label = lbl), size = 6.5, color = "gray30", segment.alpha = 0, family = "foo", nudge_x = .03, nudge_y = .2) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Loss of employment by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

hshp.2 %>%
  ggplot(aes(x = pct, y = reorder(hardships, pct), color = zipcode)) +
  geom_linerange(aes(xmin = lower, xmax = upper), size = 1, position = position_dodge(width=0.5)) +
  geom_point(aes(size = n), position = position_dodge(width = 0.5)) +
  geom_text_repel(aes(label = lbl), size = 6.5, color = "gray30", segment.alpha = 0, family = "foo", nudge_x = .03, nudge_y = .2) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Loss of employment by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

hshp.3 %>%
  ggplot(aes(x = pct, y = reorder(hardships, pct), color = zipcode)) +
  geom_linerange(aes(xmin = lower, xmax = upper), size = 1, position = position_dodge(width=0.5)) +
  geom_point(aes(size = n), position = position_dodge(width = 0.5)) +
  geom_text_repel(aes(label = lbl), size = 6.5, color = "gray30", segment.alpha = 0, family = "foo", nudge_x = .03, nudge_y = .2) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Loss of employment by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

hshp.4 %>%
  ggplot(aes(x = pct, y = reorder(hardships, pct), color = zipcode)) +
  geom_linerange(aes(xmin = lower, xmax = upper), size = 1, position = position_dodge(width=0.5)) +
  geom_point(aes(size = n), position = position_dodge(width = 0.5)) +
  geom_text_repel(aes(label = lbl), size = 6.5, color = "gray30", segment.alpha = 0, family = "foo", nudge_x = .03, nudge_y = .2) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Loss of employment by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

hshp.5 %>%
  ggplot(aes(x = pct, y = reorder(hardships, pct), color = zipcode)) +
  geom_linerange(aes(xmin = lower, xmax = upper), size = 1, position = position_dodge(width=0.5)) +
  geom_point(aes(size = n), position = position_dodge(width = 0.5)) +
  geom_text_repel(aes(label = lbl), size = 6.5, color = "gray30", segment.alpha = 0, family = "foo", nudge_x = .03, nudge_y = .2) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Loss of employment by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf

hshp.6 %>%
  ggplot(aes(x = pct, y = reorder(hardships, pct), color = zipcode)) +
  geom_linerange(aes(xmin = lower, xmax = upper), size = 1, position = position_dodge(width=0.5)) +
  geom_point(aes(size = n), position = position_dodge(width = 0.5)) +
  geom_text_repel(aes(label = lbl), size = 6.5, color = "gray30", segment.alpha = 0, family = "foo", nudge_x = .03, nudge_y = .2) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, .15), label = scales::percent) +
  scale_color_manual(values = wes_palette("Darjeeling2", n = 3)) +
  guides(color = guide_legend(label.position = "left", label.vjust = 0.5, label.hjust = 1, override.aes = list(size = 5)), size = F) +
  labs(y = NULL, x = NULL, color = NULL,
       title = "Loss of employment by zip code", 
       subtitle = str_wrap("Since the onset of COVID-19 (March 2020), has anyone in this household experienced the loss of employment income"),
       caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_classic() +
  themeuf
```



























