---
title: "San Antonio Energy and Time Use Survey"
author: "..."
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include=FALSE}
library(readxl)
library(dplyr)
library(ggplot2)
library(plotly)
library(patchwork)
library(showtext)
library(kableExtra)
library(summarytools)
library(gtsummary)
```

```{r themeu, include=FALSE, message=FALSE, warning=FALSE}
font_add_google(name = "Barlow", family = "foo")
showtext::showtext_auto()

themeu <- theme(plot.title = element_text(size = 22, face = "bold"), 
                plot.subtitle = element_text(size = 11),
                legend.position = "none", 
                legend.title = element_blank(), 
                axis.title = element_text(size = 17), 
                axis.text = element_text(size = 17), 
                axis.text.y = element_text(size = 17, color = "black"),
                plot.caption = element_text(size = 12), 
                panel.grid = element_blank(),
                strip.background = element_rect(fill = NULL, linetype = "solid"), 
                strip.text = element_text(color = "white", size = 18, face = "bold"))
```

```{r load, include=FALSE}
# From Qualtrics we get the data as .csv with default options: Recode seen but unanswered questions as -99. Recode seen but unanswered multi-value fields as 0.
# Change path
san <- read_excel("~/GitHub/saetus/San Antonio Energy and Time Use Survey (03.10).xlsx", col_names = T)
# delete responses before 22.02. These were responses from us. Delete some defaults columns, only have NA values.
san <- san[-c(1:9), - c(10:13)] 
```

```{r duration_nas, include=FALSE}
# 174 variables when uploaded.  
san <- san %>% 
  # I'm subtracting the columns (rewrite_email, gender_text, and disagree) since nobody answer the question
  mutate(number_missing_value = rowSums(is.na(san))-3,
         # 171 total possible responses (not included rewrite_email, gender_text, and disagree)
         nas_pct = round((number_missing_value/171*100)))

### NAs
summary(san$number_missing_value)
summary(san$nas_pct)

### by Peter
san <- san %>%
  mutate(duration = round(as.numeric(`Duration (in seconds)`)/60, 1),
         upper_out = quantile(duration, probs = 0.975, na.rm = T),
         upper_out2 = quantile(duration, probs = 0.95, na.rm = T), 
         lower_out = quantile(duration, probs = 0.025, na.rm = T),
         lower_out2 = quantile(duration, probs = 0.05, na.rm = T),
         na_low = quantile(nas_pct, probs = 0.10),
         na_upp = quantile(nas_pct, probs = 0.85),
         duration_min_out = if_else(duration <= lower_out, "Spend too little time", 
                                           if_else(duration >= upper_out, "Spend too much time", "Normal")),
         duration_min_out2 = if_else(duration <= lower_out2, "Below 5% quantile", 
                                           if_else(duration >= upper_out2, "Above 95% quantile", "Normal")),
         nas_out = if_else(nas_pct <= na_low, "Below 10% quantile",
                           if_else(nas_pct >= na_upp, "Above 85% quantile", "Normal")))

san$duration_min_out <- ordered(san$duration_min_out, levels = c("Spend too much time", "Normal", "Spend too little time"))
san$duration_min_out2 <- ordered(san$duration_min_out2, levels = c("Above 95% quantile", "Normal", "Below 5% quantile"))
san$nas_out <- ordered(san$nas_out, levels = c("Above 85% quantile", "Normal", "Below 10% quantile"))

san <- san %>% 
  mutate(odd_r = if_else(duration_min_out != "Normal" & nas_out == "Above 85% quantile", "Odd response", "Normal"),
         odd_r2 = if_else(duration_min_out2 != "Normal" & nas_out == "Above 85% quantile", "Odd response", "Normal"))
```

```{r plots_parti, message=FALSE, warning=FALSE}
san %>% 
  #filter(!is.na(zipcode)) %>% 
  ggplot(aes(x = zipcode, fill = duration_min_out)) +
  geom_bar() +
  geom_text(aes(label = ..count..), stat = "count", position=position_stack(0.5), vjust = 0, size = 2, color = "black") +
  scale_fill_brewer(type = "div", palette = 'Spectral') +
  #facet_grid(~ zipcode) +
  ggtitle("Duration between 0.7 min and 97.3 min = NORMAL (95% of responses)") +
  xlab("Zip code") + 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, size = 9), 
        panel.background = element_rect(fill = "gray95"))

san %>% 
  #filter(!is.na(zipcode)) %>% 
  ggplot(aes(x = zipcode, fill = duration_min_out2)) +
  geom_bar() +
  geom_text(aes(label = ..count..), stat = "count", position=position_stack(0.5), vjust = 0, size = 2, color = "black") +
  scale_fill_brewer(type = "div", palette = 'Spectral') +
  #facet_grid(~ zipcode) +
  ggtitle("Duration between 1.36 min and 71.2 min = NORMAL (90% of reponses)") +
  xlab("Zip code") + 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, size = 9), 
        panel.background = element_rect(fill = "gray95"))

san %>% 
  #filter(!is.na(zipcode)) %>% 
  ggplot(aes(x = zipcode, fill = nas_out)) +
  geom_bar() +
  geom_text(aes(label = ..count..), stat = "count", position=position_stack(0.5), vjust = 0, size = 2, color = "black") +
  scale_fill_brewer(type = "div", palette = 'Spectral') +
  #facet_grid(~ zipcode) +
  ggtitle("Number of NAs between 5 and 58 = NORMAL") +
  xlab("Zip code") + 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, size = 9), 
        panel.background = element_rect(fill = "gray95"))

plot_ly(data = san, x = ~nas_pct, y = ~duration, color = ~duration_min_out2) %>% 
  layout(title = "Duration (min) by NAs by response (%)", 
         yaxis = list(title = "Duration (min)"),
         xaxis = list(title = "Percentage of NA values"))

san %>% 
  filter(!is.na(zipcode)) %>% 
  ggplot() +
  geom_boxplot(aes(y = nas_pct, x = duration_min_out)) +
  scale_fill_brewer(type = "div", palette = 'Spectral') +
  ggtitle("NA dist. by duration in minutes") +
  xlab("Duration between 0.7 min and 97.3 min = NORMAL (95% of responses)") + 
  theme_classic() +
  theme(axis.text.x = element_text(size = 9), 
        panel.background = element_rect(fill = "gray95"))

san %>% 
  filter(!is.na(zipcode)) %>% 
  ggplot() +
  geom_boxplot(aes(y = nas_pct, x = duration_min_out, fill = as.factor(zipcode))) +
  scale_fill_brewer(type = "div", palette = 'Spectral') +
  ggtitle("NA dist. by duration in minutes by zip code") +
  xlab("Duration between 0.7 min and 97.3 min = NORMAL (95% of responses)") + 
  theme_classic() +
  theme(axis.text.x = element_text(size = 9), 
        panel.background = element_rect(fill = "gray95"))

san %>% 
  filter(!is.na(zipcode), duration < 900) %>% 
  ggplot() +
  geom_boxplot(aes(y = duration, fill = as.factor(zipcode), x = nas_out)) +
  scale_fill_brewer(type = "div", palette = 'Spectral') +
  ggtitle("Duration (min) by zip code and NA distribution") +
  xlab("Zip code") + 
  theme_classic() +
  theme(axis.text.x = element_text(size = 9), 
        panel.background = element_rect(fill = "gray95"))
```

1) Locate "odd responses" based on duration and number of NA in each response
2) Duration: a) Keep responses in (2.5%, 97.5%), b) responses in (5%, 95%)
3) NAs: a) Responses in (10%, 90%)

## Part I.

```{r dfSummary, message=FALSE, warning=FALSE}
view(dfSummary(san[, 5:173], plain.ascii = F, graph.magnif = .75, labels.col = T, max.string.width = 15), method = "render")
```

## Part II.

### Which responses to keep?

1) Consider odd response those outside the "normal" range of duration (1.36, 71) AND above 91 NA values 
2) Summary table: responses that Agree to participate, valid zip code (78202 or 78230), not an odd response

```{r, message=FALSE, warning=FALSE}
### Duration and number of NAs
kable(table(san$nas_out, san$duration_min_out), caption = "NAs (%) vs Duration (min)") %>% 
  kable_classic(full_width = F) %>% 
  footnote(general = "NAs in (10%, 90%); duration in (2.5%, 97.5%)")

kable(table(san$nas_out, san$duration_min_out2), caption = "NAs (%) vs Duration (min)") %>% 
  kable_classic(full_width = F) %>% 
  footnote(general = "NAs in (10%, 90%); duration in (5%, 95%)")  

kable(table(san$odd_r2), caption = "Odd responses") %>% 
  kable_classic(full_width = F)

san2 <- san %>% 
  # consent Agree and double check on survey participation. Keep zip code 78202 or 78230. Keep the first answer for unique emails
  filter(consent == "1" | disagree == "1", zipcode != 3, odd_r2 == "Normal") %>% 
  mutate(zipcode = if_else(zipcode == "1", "Elm Creek", 
                           if_else(zipcode == "2", "Jefferson Heights", NA_character_)),
         rep_email = if_else(email == lag(email, n = 1, order_by = email), "rep_email", "first_entry")) %>% 
  # Keep only the first response for those repeated emails 
  filter(rep_email == "first_entry")

#view(dfSummary(san2[, 5:173], plain.ascii = F, graph.magnif = .75, labels.col = T, max.string.width = 15), method = "render")
```

### Section IV. Background Characteristics by Zip code

```{r section_iv, message=FALSE, warning=FALSE}
san2 %>%
  select(16, 146, 148:171, 175, 178:189) %>% 
  tbl_summary(by = zipcode, 
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              digits = list(all_continuous() ~ c(1, 1))) %>% 
  add_n() %>% 
  add_p() %>% 
  modify_header(label = "**variable**") %>% 
  modify_caption("**Section IV. Background characteristics (N = {N})**") %>% 
  bold_labels()
```

### Section Ia. Time Use by Zip code

```{r section_ia, message=FALSE, warning=FALSE}
san2 %>%
  select(16:80, 175, 178:189) %>% 
  tbl_summary(by = zipcode, 
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              digits = list(all_continuous() ~ c(1, 1))) %>% 
  add_n() %>% 
  add_p() %>% 
  modify_header(label = "**variable**") %>% 
  modify_caption("**Section Ia. Time Use (N = {N})**") %>% 
  bold_labels()
```

### Section Ib. Energy Use by Zip code

```{r section_ib, message=FALSE, warning=FALSE}
san2 %>%
  select(16, 81:87, 175, 178:189) %>% 
  tbl_summary(by = zipcode, 
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              digits = list(all_continuous() ~ c(1, 1))) %>% 
  add_n() %>% 
  add_p() %>% 
  modify_header(label = "**variable**") %>% 
  modify_caption("**Section Ib. Energy Use (N = {N})**") %>% 
  bold_labels()
```

### Section II. Health Conditions by Zip code

```{r section_ii, message=FALSE, warning=FALSE}
san2 %>%
  select(16, 88:101, 103, 105:119, 175, 178:189) %>% 
  tbl_summary(by = zipcode, 
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              digits = list(all_continuous() ~ c(1, 1))) %>% 
  add_n() %>% 
  add_p() %>% 
  modify_header(label = "**variable**") %>% 
  modify_caption("**Section II. Health Conditions (N = {N})**") %>% 
  bold_labels()
```

### Section III. Employment by Zip code

```{r section_iii, message=FALSE, warning=FALSE}
san2 %>%
  select(16, 121:143, 175, 178:189) %>% 
  tbl_summary(by = zipcode, 
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              digits = list(all_continuous() ~ c(1, 1))) %>% 
  add_n() %>% 
  add_p() %>% 
  modify_header(label = "**variable**") %>% 
  modify_caption("**Section III. Employment (N = {N})**") %>% 
  bold_labels()
```

## Part III.

```{r recode, include=FALSE}
san <- san %>% 
  # consent Agree and double check on survey participation. Keep only zip codes 78202 or 78230.
  #filter(consent == "1" | disagree == "1", zipcode != "3") %>% 
  mutate(yrbr = ifelse(as.numeric(year) >= 1, 2000 - as.numeric(year), NA), # year of birth
         age = 2021 - yrbr, # age
         zip = if_else(zipcode == "1", "Elm Creek", "Jefferson Heights"), # recode zip codes
         hisp = if_else(hispanic == "1", "Not Hispanic", if_else(hispanic == "2", "Hispanic", "Don't know")), # Hispanic origin
         race2 = case_when(race %in% "1" ~ "White", # recode race
                           race %in% "2" ~ "Black", 
                           race %in% "3" ~ "Asian", 
                           race %in% "4" ~ "AIAN", # American Indian or Alaskan Native
                           race %in% "5" ~ "NHPI", # Native Hawaiian of Other Pacific Islander
                           race %in% c("6", "7", "8") ~ "Other"), # Two or more races; Unknown|Don't know; Prefer not to answer
         race_eth = if_else(hisp != "Hispanic" & race2 == "White", "NH-White", 
                            if_else(hisp != "Hispanic" & race2 == "Black", "NH-Black", 
                                    if_else(hisp != "Hispanic" & race2 == "Asian", "NH-Asian", 
                                            if_else(hisp != "Hispanic" & race2 == "AIAN", "NH-AIAN",
                                                    if_else(hisp != "Hispanic" & race2 == "NHPI", "NH-NHPI",
                                                            if_else(hisp != "Hispanic" & race2 == "Other", "NH-Other", "Hispanic")))))),
         gender = case_when(gender %in% "1" ~ "Female", 
                            gender %in% "2" ~ "Male", 
                            gender %in% c("3", "4", "5", "6", "7") ~ "Other"),
         marital_st = case_when(marital %in% "1" ~ "Single",
                                marital %in% c("2", "3") ~ "In a union", # married/living in a marriage-like relationship
                                marital %in% c("4", "5", "6") ~ "Not in a union"), # widowed, separated, divorced
         educ = case_when(education %in% "1" ~ "Less than HS", 
                          education %in% c("2", "3") ~ "High School", # some high school, high school graduate or equivalent 
                          education %in% c("4", "5", "6") ~ "College", # some college, AA, BA, BS
                          education %in% "7" ~ "Graduate",
                          education %in% "8" ~ "Don't know"),
         health = case_when(health %in% "1" ~ "Excellent", health %in% "2" ~ "Very good", health %in% "3" ~ "Good", 
                            health %in% "4" ~ "Fair", health %in% "5" ~ "Poor"))

san$race_eth <- ordered(san$race_eth, levels = c("NH-White", "NH-Black", "NH-Asian", "NH-AIAN", "NH-NHPI", "NH-Other", "Hispanic"))
san$health <- ordered(san$health, levels = c("Excellent", "Very good", "Good", "Fair", "Poor"))
```

```{r rep_emails, include=FALSE, eval=FALSE}
### Replicated email addresses 
unique_emails <- unique(san$email)
rep_emails <- c("AdrianaHudsonwhp@yahoo.com", "AliRushwynf@yahoo.com", "altenwerthvbwht42@gmail.com", "ArdenHubbardvqk@yahoo.com",
               "ArnoldRatigmw@gmail.com", "AthenaHerringjuw@yahoo.com", "augustusyzlk19@gmail.com", "charlesfpsk94@gmail.com",
               "choeaqzn14@gmail.com", "choeaqzn14@gmail.com", "ChristinaEdwardsaocv@yahoo.com", "deboeremh85@gmail.com", 
               "DianaRiosavb@yahoo.com", "dooleyqigx99@gmail.com", "EliGrahamfsxa@yahoo.com", "fochttdlfv47@gmail.com",
               "harrisckzi97@gmail.com", "hubbardpaul564@gmail.com", "IngridBuckleyuqgg@yahoo.com", "JaelynPettyvah@yahoo.com",
               "JeffreyRojaseeko@yahoo.com", "LatoyaParkermkiu@yahoo.com", "MalcomRyantom@yahoo.com", "NanetteWrighthys@yahoo.com",
               "PedroDawsonsifc@yahoo.com", "PhillipBuckleygmmm@yahoo.com", "RafaelManningygoo@yahoo.com", "rodggersmmaison@gmail.com",
               "SheaMillerkcbe@yahoo.com", "tameracaqcx43@gmail.com", "TraciRivasrqy@yahoo.com", "TyrellCowanjqm@yahoo.com", 
               "ValerieLevyiuaz@yahoo.com", "wheelerjoselyn@gmail.com")
san <- san %>% 
  mutate(rep_email = if_else(email == lag(email, n = 1, order_by = email), "rep_email", "first_entry"))

san_re <- san %>% 
  mutate(rep_email = if_else(email == lag(email, n = 1, order_by = email), "rep_email", "first_entry")) %>% 
  filter(email %in% rep_emails) %>% 
  arrange(email)

save(san, file = "~/GitHub/san/sa_survey.RData")
save(san_re, file = "~/GitHub/san/sa_survey_rep_emails.RData")

write.csv(x = unique_emails, file = "~/GitHub/san/unique_emails.csv")
write.csv(x = rep_emails, file = "~/GitHub/san/repeated_emails.csv")

write.csv(x = san, file = "~/GitHub/san/sa_energy_survey.csv", row.names = F)
write.csv(x = san_re, file = "~/GitHub/san/sa_energy_survey_rep_emails.csv", row.names = F)
```

```{r emails, include=FALSE, eval=FALSE}
### EMAILS
#### IDs
emails <- san %>% 
  mutate(rep_email = if_else(email == lag(email, n = 1, order_by = email), "rep_email", "first_entry"),
         mean_duration = round(mean(duration, na.rm = T), 1),
         median_duration = median(duration, na.rm = T),
         nas = rowSums(is.na(.)) - 4,
         na_pct = round(nas/161 * 100, 1)) %>% 
  filter(rep_email == "first_entry" & zip != 3) %>% 
  select(ResponseId, email, zip, duration, mean_duration, median_duration, nas, na_pct) %>%  
  arrange(duration, na_pct)


write.csv(x = emails, file = "~/GitHub/saetus/emails.csv", row.names = F)
```

```{r recode_health, include=FALSE, eval=FALSE}
san <- san %>% 
  #filter(Finished == "1") %>% # what to do with the responses not finished
  mutate(ageg = case_when(age %in% min(age):29 ~ "20-29",
                          age %in% 30:39 ~ "30-39",
                          age %in% 40:49 ~ "40-49",
                          age %in% 50:59 ~ "50-59",
                          age %in% 60:max(age) ~ "60+", FALSE ~ NA_character_),
         anxious = if_else(mental_health_anxious == "1", "Not at all",
                           if_else(mental_health_anxious == "2", "Several days", 
                                   if_else(mental_health_anxious == "3", "More than half",
                                           if_else(mental_health_anxious == "4", "Nearly every day", 
                                                   if_else(mental_health_anxious != c("1", "2", "3", "4"), "NA", mental_health_anxious))))),
         worry = if_else(mental_health_worry == "1", "Not at all",
                           if_else(mental_health_worry == "2", "Several days", 
                                   if_else(mental_health_worry == "3", "More than half",
                                           if_else(mental_health_worry == "4", "Nearly every day", 
                                                   if_else(mental_health_worry != c("1", "2", "3", "4"), "NA", mental_health_worry))))),
         interest = if_else(mental_health_interest == "1", "Not at all",
                           if_else(mental_health_interest == "2", "Several days", 
                                   if_else(mental_health_interest == "3", "More than half",
                                           if_else(mental_health_interest == "4", "Nearly every day", 
                                                   if_else(mental_health_interest != c("1", "2", "3", "4"), "NA", mental_health_interest))))),
         down = if_else(mental_health_down == "1", "Not at all",
                           if_else(mental_health_down == "2", "Several days", 
                                   if_else(mental_health_down == "3", "More than half",
                                           if_else(mental_health_down == "4", "Nearly every day", 
                                                   if_else(mental_health_down != c("1", "2", "3", "4"), "NA", mental_health_down))))),
         pre_c19_ph = if_else(pre_phy_health == "1", "Worse", 
                              if_else(pre_phy_health == "2", "Same", 
                                      if_else(pre_phy_health == "3", "Better", pre_phy_health))),
         pre_c19_mh = if_else(pre_mental_health == "1", "Worse", 
                              if_else(pre_mental_health == "2", "Same", 
                                      if_else(pre_mental_health == "3", "Better", pre_mental_health))))

san$anxious <- ordered(san$anxious, levels = c("Not at all", "Several days", "More than half", "Nearly every day"))
san$worry <- ordered(san$worry, levels = c("Not at all", "Several days", "More than half", "Nearly every day"))
san$interest <- ordered(san$interest, levels = c("Not at all", "Several days", "More than half", "Nearly every day"))
san$down <- ordered(san$down, levels = c("Not at all", "Several days", "More than half", "Nearly every day"))
san$pre_c19_ph <- ordered(san$pre_c19_ph, levels = c("Worse", "Same", "Better"))
san$pre_c19_mh <- ordered(san$pre_c19_mh, levels = c("Worse", "Same", "Better"))
```

```{r recode_employment, include=FALSE, eval=FALSE}
san <- san %>% 
  mutate(front = if_else(frontline == "1", "Yes", 
                         if_else(frontline == "2", "No", "NA")),
         work_hrs = as.numeric(hrs_work_3),
         hsh_size = as.numeric(num_hsh),
         hsh_child = as.numeric(num_children),
         hsh_retire = as.numeric(num_retired))
```

```{r health_status_plot, message=FALSE, warning=FALSE, eval=FALSE}
load("~/GitHub/san/sa_survey.RData")

san %>% 
  filter(health != "NA") %>% 
  ggplot(aes(x = race_eth, fill = health)) +
  geom_bar() +
  geom_text(aes(label = ..count..), stat = "count", position=position_stack(0.5), vjust = 0, size = 2) +
  scale_fill_viridis_d(option = "E", begin = .2, end = .8) +
  facet_grid(~zip) +
  ggtitle("Responses by zip code and mental health status", 
          subtitle = "How often have you been bothered by the feeling nervous, anxious, or on edge") +
  xlab(NULL) + 
  theme_light() +
  theme(axis.text.x = element_text(angle = 90, size = 9))

san %>% 
  filter(anxious != "NA", worry != "NA", interest != "NA", down!= "NA") %>% 
  ggplot(aes(x = race_eth, fill = anxious)) +
  geom_bar() +
  geom_text(aes(label = ..count..), stat = "count", position=position_stack(0.5), vjust = 0, size = 2) +
  scale_fill_viridis_d(option = "E", begin = .2, end = .8) +
  facet_grid(~zip) +
  ggtitle("Responses by zip code and mental health status", 
          subtitle = "How often have you been bothered by the feeling nervous, anxious, or on edge") +
  xlab(NULL) + 
  theme_light() +
  theme(axis.text.x = element_text(angle = 90, size = 9))

san %>% 
  filter(anxious != "NA", worry != "NA", interest != "NA", down!= "NA", !is.na(race_eth)) %>% 
  ggplot(aes(x = race_eth, fill = worry)) +
  geom_bar() +
  geom_text(aes(label = ..count..), stat = "count", position=position_stack(0.5), vjust = 0, size = 2) +
  scale_fill_viridis_d(option = "E", begin = .2, end = .8) +
  facet_grid(~ zip) +
  ggtitle("Responses by zip code and mental health status", 
          subtitle = "How often have you been bothered by not being able to stop or control worrying") +
  xlab(NULL) + 
  theme_light() +
  theme(axis.text.x = element_text(angle = 90, size = 9))

san %>% 
  filter(anxious != "NA", worry != "NA", interest != "NA", down!= "NA", !is.na(race_eth)) %>% 
  ggplot(aes(x = race_eth, fill = interest)) +
  geom_bar() +
  geom_text(aes(label = ..count..), stat = "count", position=position_stack(0.5), vjust = 0, size = 2) +
  scale_fill_viridis_d(option = "E", begin = .2, end = .8) +
  facet_grid(~ zip) +
  ggtitle("Responses by zip code and mental health status", 
          subtitle = "How often have you been bothered by having little interest or pleasure in doing things") +
  xlab(NULL) + 
  theme_light() +
  theme(axis.text.x = element_text(angle = 90, size = 9))

san %>% 
  filter(anxious != "NA", worry != "NA", interest != "NA", down!= "NA", !is.na(race_eth)) %>% 
  ggplot(aes(x = race_eth, fill = down)) +
  geom_bar() +
  geom_text(aes(label = ..count..), stat = "count", position=position_stack(.5), vjust = 0, size = 2) +
  scale_fill_viridis_d(option = "E", begin = .2, end = .8) +
  facet_grid(~ zip) +
  ggtitle("Responses by zip code and mental health status", 
          subtitle = "How often have you been bothered by feeling down, depressed, or hopeless") +
  xlab(NULL) + 
  theme_light() +
  theme(axis.text.x = element_text(angle = 90, size = 9))

san %>% 
  filter(pre_c19_ph != "NA", pre_c19_mh != "NA", !is.na(race_eth)) %>% 
  ggplot(aes(x = race_eth, fill = pre_c19_ph)) +
  geom_bar() +
  geom_text(aes(label = ..count..), stat = "count", position=position_stack(.5), vjust = 0, size = 2) +
  scale_fill_viridis_d(option = "D", begin = .2, end = .8) +
  facet_grid(~ zip) +
  ggtitle("Responses by zip code and physical health prior to COVID-19") +
  xlab(NULL) + 
  theme_light() +
  theme(axis.text.x = element_text(angle = 90, size = 9))

san %>% 
  filter(pre_c19_ph != "NA", pre_c19_mh != "NA", !is.na(race_eth)) %>% 
  ggplot(aes(x = race_eth, fill = pre_c19_mh)) +
  geom_bar() +
  geom_text(aes(label = ..count..), stat = "count", position=position_stack(.5), vjust = 0, size = 2) +
  scale_fill_viridis_d(option = "D", begin = .2, end = .8) +
  facet_grid(~ zip) +
  ggtitle("Responses by zip code and mental health prior to COVID-19") +
  xlab(NULL) + 
  theme_light() +
  theme(axis.text.x = element_text(angle = 90, size = 9))
```

```{r frontline_plot, eval=FALSE}
san %>% 
  filter(front != "NA") %>% 
  ggplot(aes(x = race_eth, fill = front)) +
  geom_bar() +
  geom_text(aes(label = ..count..), stat = "count", position=position_stack(0.5), vjust = 0, size = 2, color = "white") +
  scale_fill_viridis_d(option = "B", begin = .2, end = .8) +
  facet_grid(~ zip) +
  ggtitle("Responses by zip code and identification as frontline worker") +
  xlab(NULL) + 
  theme_light() +
  theme(axis.text.x = element_text(angle = 90, size = 9))

san %>% 
  filter(front != "NA",  gender != "NA", work_hrs > 0 ) %>% 
  ggplot() +
  geom_col(aes(x = work_hrs, y = race_eth, color = gender, fill = gender), position = "dodge", width = .5) +
  facet_grid(~ zip) +
  scale_color_viridis_d(option = "E", begin = .2, end = .8) +
  scale_fill_viridis_d(option = "E", begin = .2, end = .8) +
  ggtitle("Responses by zip code and working hours per week") +
  xlab("Hours per week") + 
  ylab(NULL) +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90, size = 9))
```

```{r, include=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
san %>% 
  group_by(race_eth, zip, gender) %>% 
  dplyr::summarise(poorh = round(mean(as.numeric(days_poor_health), na.rm = T), 1)) %>% 
  ungroup() %>% 
  select(race_eth, zip, gender, poorh) %>% 
  filter(gender != "Other", race_eth!= "NH-Other") %>% 
  mutate(label = poorh) %>% 
  ggplot(aes(x = poorh, y = race_eth)) +
  geom_line(color = "gray50", size = 1) +
  geom_point(aes(fill = as.factor(gender), color = as.factor(gender)), size = 4, shape = 19) +
  facet_grid(~zip) +
  geom_text(aes(label = label, x = poorh), nudge_y = 0.25, size = 4.5) +
  geom_text(aes(label = gender, x = poorh), nudge_y = -0.25, size = 4.5) +
  scale_color_brewer(type = "qual", palette = "Dark2") +
  scale_fill_brewer(type = "qual") +
  labs(title = "Days of poor health | Women and Men by race and ethnicity",
    x = "Average number of days with poor physical or mental health in January 2021",
    y = NULL, 
    caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_linedraw() +
  themeu
  
san %>% 
  group_by(educ, zip, gender) %>% 
  dplyr::summarise(poorh = round(mean(as.numeric(days_poor_health), na.rm = T), 1)) %>% 
  ungroup() %>% 
  select(educ, zip, gender, poorh) %>% 
  filter(gender != "Other", educ != "NA") %>% 
  mutate(label = poorh) %>% 
  ggplot(aes(x = poorh, y = educ)) +
  geom_line(color = "gray50", size = 1) +
  geom_point(aes(fill = as.factor(gender), color = as.factor(gender)), size = 4, shape = 19) +
  facet_grid(~zip) +
  geom_text(aes(label = label, x = poorh), nudge_y = 0.25, size = 4.5) +
  geom_text(aes(label = gender, x = poorh), nudge_y = -0.25, size = 4.5) +
  scale_color_brewer(type = "qual", palette = "Dark2") +
  scale_fill_brewer(type = "qual") +
  labs(title = "Days of poor health | Women and Men by education level",
    x = "Average number of days with poor physical or mental health in January 2021", 
    y = NULL, 
    caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_linedraw() +
  themeu

san %>% 
  group_by(front, zip, gender) %>% 
  dplyr::summarise(poorh = round(mean(as.numeric(days_poor_health), na.rm = T), 1)) %>% 
  ungroup() %>% 
  select(front, zip, gender, poorh) %>% 
  filter(gender != "Other", front != "NA") %>% 
  mutate(label = poorh) %>% 
  ggplot(aes(x = poorh, y = front)) +
  geom_line(color = "gray50", size = 1) +
  geom_point(aes(fill = as.factor(gender), color = as.factor(gender)), size = 4, shape = 19) +
  facet_grid(~zip) +
  geom_text(aes(label = label, x = poorh), nudge_y = 0.25, size = 4.5) +
  geom_text(aes(label = gender, x = poorh), nudge_y = -0.25, size = 4.5) +
  scale_color_brewer(type = "qual", palette = "Dark2") +
  scale_fill_brewer(type = "qual") +
  labs(title = "Days of poor health | Women and Men by frontline worker status",
    x = "Average number of days with poor physical or mental health in January 2021", 
    y = NULL, 
    caption = "Source: 2021 San Antonio Energy and Time Use Survey") +
  theme_linedraw() +
  themeu
```

```{r sections, include=FALSE, message=FALSE, warning=FALSE}
# section Ia
san.ia <- san2 %>% select(ResponseId, 16:80, 175:177) 
# section Ib
san.ib <- san2 %>% select(ResponseId, 16, 81:87, 175:177) 
# section II
san.ii <- san2 %>% select(ResponseId, 16, 88:101, 103, 105:119, 175:177) 
# section III
san.iii <- san2 %>% select(ResponseId, 16, 121:143, 175:177) 
# section IV
san.iv <- san2 %>% select(ResponseId, 16, 146, 148:171, 175:177) 
```

```{r section_ia, include=FALSE, message=FALSE, warning=FALSE}
san.ia <- san.ia %>% 
  rename(sleep.t = per_care_1, eat.t = per_care_2, cook.t = per_care_3, groom.t = per_care_4,
         sleep.w = per_care_wknd_1, eat.w = per_care_wknd_2, cook.w = per_care_wknd_3, groom.w = per_care_wknd_4,
         sleep.t.w = pc_wknd_time_1, eat.t.w = pc_wknd_time_2, cook.t.w = pc_wknd_time_3, groom.t.w = pc_wknd_time_4,
         sleep.covid = per_care_covid_1, eat.covid = per_care_covid_2, cook.covid = per_care_covid_3, groom.covid = per_care_covid_4,
         
         class.t = st_act_1, hmwrk.t = st_act_2, commute.t = st_act_3,
         class.w = st_act_wknd_1, hmwrk.w = st_act_wknd_2, commute.w = st_act_wknd_3,
         class.t.w = sa_wknd_time_1, hmwrk.t.w = sa_wknd_time_2, commute.t.w = sa_wknd_time_3,
         class.covid = st_act_covid_1, hmwrk.covid = st_act_covid_2, commute.covid = st_act_covid_3,
         
         tv.t = dev_act_1, pc.t = dev_act_7, radio.t = dev_act_3, xbox.t = dev_act_6,
         tv.w = dev_act_wknd_1, pc.w = dev_act_wknd_2, radio.w = dev_act_wknd_3, xbox.w = dev_act_wknd_4,
         tv.t.w = da_wknd_time_1, pc.t.w = da_wknd_time_2, radio.t.w = da_wknd_time_3, xbox.t.w = da_wknd_time_6,
         tv.covid = dev_act_covid_1, stream.covid = dev_act_covid_2, radio.covid = dev_act_covid_3, snet.covid = dev_act_covid_4,
         text.covid = dev_act_covid_5, pc.covid = dev_act_covid_6, xbox.covid = dev_act_covid_7,
         
         read.t = other_act_1, clean.t = other_act_2, wash.t = other_act_3, repair.t = other_act_4, 
         read.w = other_act_wknd_1, clean.w = other_act_wknd_2, wash.w = other_act_wknd_3, repair.w = other_act_wknd_4, 
         read.t.w = oa_wknd_time_1, clean.t.w = oa_wknd_time_2, wash.t.w = oa_wknd_time_3, repair.t.w = oa_wknd_time_4,
         read.covid = other_act_covid_1, clean.covid=other_act_covid_2, wash.covid=other_act_covid_3, repair.covid=other_act_covid_4) %>%

     mutate(sleep.w = if_else(sleep.w == 4, "Same time as weekdays", "Different time"),
            eat.w = if_else(eat.w == 4, "Same time as weekdays", "Different time"),
            cook.w = if_else(cook.w == 4, "Same time as weekdays", "Different time"),
            groom.w = if_else(groom.w == 4, "Same time as weekdays", "Different time"),
            class.w = if_else(class.w == 3, "Same time as weekdays", "Different time"),
            hmwrk.w = if_else(hmwrk.w == 3, "Same time as weekdays", "Different time"),
            commute.w = if_else(commute.w == 3, "Same time as weekdays", "Different time"),
            tv.w = if_else(tv.w == 3, "Same time as weekdays", "Different time"),
            pc.w = if_else(pc.w == 3, "Same time as weekdays", "Different time"),
            radio.w = if_else(radio.w == 3, "Same time as weekdays", "Different time"),
            xbox.w = if_else(xbox.w == 3, "Same time as weekdays", "Different time"),
            read.w = if_else(read.w == 3, "Same time as weekdays", "Different time"),
            clean.w = if_else(clean.w == 3, "Same time as weekdays", "Different time"),
            wash.w = if_else(wash.w == 3, "Same time as weekdays", "Different time"),
            repair.w = if_else(repair.w == 3, "Same time as weekdays", "Different time"),
            own_device = case_when(own_device %in% 3 ~ "Both personal computer and TV",
                                   own_device %in% 2 ~ "Only TV",
                                   own_device %in% 1 ~ "Only personal computer",
                                   own_device %in% 4 ~ "Neither PC nor TV")) %>% 
  
  mutate_at(vars(sleep.t:groom.t, class.t:commute.t, tv.t:xbox.t, read.t:repair.t, 
                 sleep.t.w:groom.t.w, class.t.w:commute.t.w, tv.t.w:xbox.t.w, read.t.w:repair.t.w), 
            funs(recode(., '-99' = NA_real_))) %>%  
  
  mutate_at(vars(sleep.covid:groom.covid, class.covid:commute.covid, tv.covid:xbox.covid, read.covid:repair.covid), 
            funs(recode(.,'1'="Much less time",'2'="Somewhat less time",'3'="About the same",'4'="Somewhat more time",'5'="Much more time",'6'=NA_character_))) %>% 
  
  mutate(sleep.tt = if_else(sleep.w == "Same time as weekdays", 7*sleep.t, 5*sleep.t + 2*sleep.t.w),
         eat.tt = if_else(eat.w == "Same time as weekdays", 7*eat.t, 5*eat.t + 2*eat.t.w),
         cook.tt = if_else(cook.w == "Same time as weekdays", 7*cook.t, 5*cook.t + 2*cook.t.w),
         groom.tt = if_else(groom.w == "Same time as weekdays", 7*groom.t, 5*groom.t + 2*groom.t.w),
         class.tt = if_else(class.w == "Same time as weekdays", 7*class.t, 5*class.t + 2*class.t.w),
         hmwrk.tt = if_else(hmwrk.w == "Same time as weekdays", 7*hmwrk.t, 5*hmwrk.t + 2*hmwrk.t.w),
         commute.tt = if_else(commute.w == "Same time as weekdays", 7*commute.t, 5*commute.t + 2*commute.t.w),
         tv.tt = if_else(tv.w == "Same time as weekdays", 7*tv.t, 5*tv.t + 2*tv.t.w),
         pc.tt = if_else(pc.w == "Same time as weekdays", 7*pc.t, 5*pc.t + 2*pc.t.w),
         radio.tt = if_else(radio.w == "Same time as weekdays", 7*radio.t, 5*radio.t + 2*radio.t.w),
         xbox.tt = if_else(xbox.w == "Same time as weekdays", 7*xbox.t, 5*xbox.t + 2*xbox.t.w),
         read.tt = if_else(read.w == "Same time as weekdays", 7*read.t, 5*read.t + 2*read.t.w),
         clean.tt = if_else(clean.w == "Same time as weekdays", 7*clean.t, 5*clean.t + 2*clean.t.w),
         wash.tt = if_else(wash.w == "Same time as weekdays", 7*wash.t, 5*wash.t + 2*wash.t.w),
         repair.tt = if_else(repair.w == "Same time as weekdays", 7*repair.t, 5*repair.t + 2*repair.t.w))
```

```{r}
san.ia %>% 
  select(2, 15:18, 28:30, 44:50, 63:66, 70:84) %>% 
  tbl_summary(by = zipcode, 
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
              digits = list(all_continuous() ~ c(1, 1))) %>% 
  add_n() %>% 
  add_p() %>% 
  modify_header(label = "**variable**") %>% 
  modify_caption("**Section Ia. Time Use (N = {N})**") %>% 
  bold_labels()
```

```{r section_ib}
san.ib %>% 
  select(2, pre_electric:post_trans) %>% 
  tbl_summary(by = zipcode,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
              digits = list(all_continuous() ~ c(1, 1))) %>%
  add_n() %>% 
  add_p() %>% 
  modify_header(label = "**variable**") %>% 
  modify_caption("**Section Ib. Energy Use (N = {N})**") %>% 
  bold_labels()
```

```{r section_ii}
san.ii <- san.ii %>% 
  rename(wheelchair = med_device_1, e_bed = med_device_2, person_lifting = med_device_3, dialysis_machine = med_device_4, ventilator = med_device_5, 
         cpap_bipap = med_device_6, nebulizer = med_device_7, e_recliner = med_device_8, iv_pump = med_device_9, phototherapy = med_device_10,
         other = med_device_11, impairment_hsh = impairment_hsh...103, major_impairment_hsh = impairment_hsh...107) %>% 
  mutate(health = case_when(health %in% "1"~"Excellent", 
                            health %in% "2"~"Very good", 
                            health %in% "3"~"Good", 
                            health %in% "4"~"Fair", 
                            health %in% "5"~"Poor")) %>% 
  mutate_at(vars(mental_health_anxious:mental_health_down), 
            funs(recode(., '1' = "Not at all", '2' = "Several days", '3' = "More than half the days", '4' = "Nearly every day", '-99' = NA_character_))) %>% 
  mutate_at(vars(pre_phy_health:pre_mental_health), 
            funs(recode(., '1' = "Worse", '2' = "About the same", '3' = "Better", '-99' = "Don't know"))) %>% 
  mutate_at(vars(impairment:impairment_hsh), funs(recode(., '1' = "Yes", '2' = "No", '-99' = NA_character_))) %>% 
  mutate_at(vars(major_impairment:major_impairment_hsh), funs(recode(., '1' = "Arthritis/rheumatism", 
                                                                     '2' = "Back or neck problem",  
                                                                     '3' = "Fractures, bone/joint injury", 
                                                                     '4' = "Walking problem",
                                                                     '5' = "Lung/breathing problem", 
                                                                     '6' = "Hearing problem", 
                                                                     '7' = "Eye/vision problem", 
                                                                     '8' = "Heart problem",
                                                                     '9' = "Stroke problem", 
                                                                     '10' = "Hypertension/high blood pressure",
                                                                     '11' = "Diabetes", 
                                                                     '12' = "Cancer",
                                                                     '13' = "Depression/anxiety/emotional problem", 
                                                                     '14' = "Other impairment/problem",
                                                                     '-99' = NA_character_))) %>% 
  mutate_at(vars(days_impairment_1:years_impairment_1), funs(recode(., '-99' = NA_real_))) %>% 
  mutate_at(vars(wheelchair:other), funs(recode(., '1' = "Yes", '0' = "No", '-99' = NA_character_)))

san.ii$health <- ordered(san.ii$health, levels = c("Excellent", "Very good", "Good", "Fair", "Poor"))
```

```{r}
san.ii %>% 
  select(2:32) %>% 
  tbl_summary(by = zipcode,
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              digits = list(all_continuous() ~ c(1, 1))) %>%
  add_n() %>% 
  add_p() %>% 
  modify_header(label = "**variable**") %>% 
  modify_caption("**Section II. Health Conditions (N = {N})**") %>% 
  bold_labels()
```

```{r section_iii}
san.iii <- san.iii %>% 
  rename(eip_food = eip_1, eip_hsh = eip_2, eip_rent = eip_3, eip_utilities = eip_4, eip_credit = eip_5, eip_other = eip_6, eip_dn = eip_7) %>% 
  mutate(work_home = if_else(work_home == 3, "Yes", if_else(work_home == 4, "No", NA_character_))) %>% 
  mutate_at(vars(emp_status:emp_status_partner), funs(recode(., 
                                                             '1' = "Work for pay at a job",
                                                             '2' = "Layoff from a job",
                                                             '3' = "Temporarily absent from job",
                                                             '4' = "Actively looking for a job",
                                                             '5' = "Retired",
                                                             '6' = "Unable to work", 
                                                             '7' = NA_character_))) %>% 
  mutate_at(vars(work_home_partner:frontline_partner), funs(recode(., '1' = "Yes", '2' = "No", '-99' = NA_character_ ))) %>% 
  mutate_at(vars(hrs_work_3:hrs_commute_partnet_3), funs(recode(., '-99' = NA_real_))) %>% 
  mutate(working_t = hrs_work_3 + (hrs_work_4/60), 
         working_t_p = hrs_work_partner_3 + (hrs_work_partner_4/60),
         commuting_t = (min_commute_3/60) + hrs_commute_3,
         commuting_t_p = (min_commute_partner_3/60) + hrs_commute_partnet_3) %>% 
  mutate_at(vars(rsn_nowork:rsn_nowork_partner), funs(recode(., 
                                                             '1' = "Sick with coronavirus symptoms", 
                                                             '2' = "Caring for someone else",
                                                             '3' = "Employer closed", 
                                                             '4' = "Other reason", 
                                                             '-99' = NA_character_))) %>% 
  mutate_at(vars(eip_food:eip_dn), funs(recode(., '1' = "Yes", '0' = "No", '-99' = NA_character_))) 
```

```{r}
san.iii %>% 
  select(2:25, 29:32) %>% 
  tbl_summary(by = zipcode,
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              digits = list(all_continuous() ~ c(1, 1))) %>%
  add_n() %>% 
  add_p() %>% 
  modify_header(label = "**variable**") %>% 
  modify_caption("**Section III. Employment (N = {N})**") %>% 
  bold_labels()
```

```{r section_iv}
san.iv <- san.iv %>% 
  
```








